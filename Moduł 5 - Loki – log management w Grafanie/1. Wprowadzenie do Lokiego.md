# Wprowadzenie do Lokiego

Loki to nowoczesny system agregacji i zarządzania logami, zaprojektowany przez zespół Grafana Labs. W przeciwieństwie do tradycyjnych rozwiązań do zarządzania logami, Loki nie indeksuje pełnej zawartości logów, a jedynie metadane (etykiety), co czyni go niezwykle wydajnym i ekonomicznym rozwiązaniem. Loki został zainspirowany architekturą Prometheusa i idealnie integruje się z ekosystemem Grafany, tworząc kompletną platformę do monitorowania metryk i logów.

## Czym jest Loki?

**Loki** to otwartoźródłowy (open-source) system agregacji logów, który został zaprojektowany z myślą o:
- **Prostocie** – minimalistyczna architektura, łatwa w instalacji i konfiguracji
- **Wydajności** – indeksowanie tylko metadanych zamiast pełnej zawartości logów
- **Skalowalnści** – możliwość obsługi dużych wolumenów logów
- **Integracji** – natywna integracja z Grafaną i Prometheusem

### Główne cechy Lokiego:

- **Indeksowanie etykiet**: Loki indeksuje tylko metadane (etykiety) podobnie jak Prometheus, co znacząco redukuje zużycie zasobów
- **LogQL**: Język zapytań inspirowany PromQL, umożliwiający efektywne przeszukiwanie i analizę logów
- **Multi-tenancy**: Wsparcie dla wielu użytkowników/zespołów w jednej instancji
- **Ekonomiczność**: Niższe koszty przechowywania w porównaniu do tradycyjnych rozwiązań (np. ELK Stack)
- **Natywna integracja**: Doskonała integracja z Grafaną, Prometheusem i Promtail

## Architektura Lokiego

System Loki składa się z trzech głównych komponentów:

### 1. **Loki (serwer)**

Główny komponent odpowiedzialny za:
- Przyjmowanie logów od agentów (np. Promtail)
- Indeksowanie etykiet
- Przechowywanie logów
- Obsługę zapytań LogQL

### 2. **Promtail (agent)**

Agent odpowiedzialny za:
- Zbieranie logów z różnych źródeł (pliki, systemd, Docker, Kubernetes)
- Dodawanie etykiet do logów
- Wysyłanie logów do serwera Loki

### 3. **Grafana (interfejs użytkownika)**

Interfejs do:
- Przeglądania i przeszukiwania logów
- Tworzenia dashboardów z wizualizacją logów
- Korelacji logów z metrykami z Prometheusa
- Konfiguracji alertów na podstawie logów

```
┌─────────────┐        ┌──────────┐        ┌──────────┐
│   Promtail  │───────▶│   Loki   │◀───────│  Grafana │
│   (Agent)   │  HTTP  │ (Serwer) │  HTTP  │   (UI)   │
└─────────────┘        └──────────┘        └──────────┘
      │                     │
      │                     │
      ▼                     ▼
   Źródła              Przechowywanie
   logów               (Local/S3/GCS)
```

## Loki vs tradycyjne rozwiązania

### Porównanie Loki z innymi systemami:

| Cecha | Loki | Elasticsearch (ELK) | Splunk |
|-------|------|---------------------|--------|
| **Indeksowanie** | Tylko etykiety | Pełna zawartość | Pełna zawartość |
| **Koszt przechowywania** | Niski | Wysoki | Bardzo wysoki |
| **Złożoność** | Niska | Wysoka | Średnia |
| **Integracja z Grafaną** | Natywna | Dobra | Dobra |
| **Język zapytań** | LogQL | Lucene Query | SPL |
| **Wymagania zasobów** | Niskie | Wysokie | Średnie |

### Dlaczego Loki?

**Zalety:**
- **Ekonomiczne przechowywanie**: Brak indeksowania pełnej zawartości = niższe koszty
- **Prosta architektura**: Łatwa w wdrożeniu i utrzymaniu
- **Ekosystem Grafana**: Jednolite środowisko dla metryk (Prometheus) i logów (Loki)
- **Elastyczne etykietowanie**: Podobny model do Prometheusa
- **Skalowalne**: Od pojedynczej instancji do rozproszonych klastrów

**Ograniczenia:**
- **Wyszukiwanie pełnotekstowe**: Mniej wydajne niż Elasticsearch
- **Zaawansowane analizy**: Brak wbudowanych narzędzi analitycznych jak w Splunk
- **Młodszy ekosystem**: Mniej narzędzi i integracji niż ELK Stack

## Przypadki użycia Lokiego

### 1. **Monitorowanie aplikacji**
Zbieranie logów aplikacyjnych w celu:
- Debugowania problemów
- Śledzenia błędów
- Analizy wydajności

### 2. **Monitorowanie infrastruktury**
Agregacja logów systemowych:
- Logi systemowe (syslog, journald)
- Logi usług systemowych
- Logi kontenerów (Docker, Kubernetes)

### 3. **Korelacja metryk i logów**
Łączenie danych z Prometheusa i Lokiego:
- Analiza przyczyn alertów
- Kontekstowa analiza problemów
- Debugowanie na podstawie metryk i logów

### 4. **Compliance i audyt**
Centralizacja logów dla:
- Audytu bezpieczeństwa
- Zgodności z regulacjami (GDPR, HIPAA)
- Śledzenia zmian w systemie

## Model etykiet w Lokiego

Podobnie jak Prometheus, Loki wykorzystuje **etykiety (labels)** do organizacji i filtrowania logów:

### Przykłady etykiet:

```logql
{job="nginx", environment="production"}
{app="api", host="server01", level="error"}
{namespace="backend", pod="api-xyz123"}
```

**Dobre praktyki etykietowania:**
- Używaj małej liczby etykiet (5-10 na stream)
- Etykiety powinny być **niskokardinalne** (niewiele unikalnych wartości)
- Nie używaj danych dynamicznych jako etykiet (np. ID użytkownika, timestamp)
- Używaj etykiet do filtrowania, nie do przeszukiwania zawartości

### Przykład złego etykietowania:

```logql
# ❌ ZŁE - wysoka kardynalność
{user_id="12345", request_id="abc-def-ghi"}
```

### Przykład dobrego etykietowania:

```logql
# ✅ DOBRE - niska kardynalność
{service="api", environment="prod", level="error"}
```

## LogQL – język zapytań Lokiego

**LogQL** to język zapytań Lokiego, inspirowany PromQL z Prometheusa. Składa się z dwóch głównych elementów:

### 1. **Selektor strumienia logów**

Wybór logów na podstawie etykiet:

```logql
{job="nginx"}
{app="api", level="error"}
```

### 2. **Filtry i transformacje**

Przeszukiwanie i przetwarzanie zawartości logów:

```logql
# Wyszukiwanie słowa w logach
{job="nginx"} |= "error"

# Wykluczenie wzorca
{job="nginx"} != "debug"

# Parsowanie JSON
{job="api"} | json | status_code >= 400

# Wyrażenia regularne
{job="nginx"} |~ "error|warning"
```

### Przykładowe zapytania LogQL:

```logql
# Wszystkie błędy z aplikacji API w ostatniej godzinie
{app="api"} |= "error"

# Zliczanie błędów 500 w logach nginx
sum(rate({job="nginx"} |= "500" [5m]))

# Parsowanie JSON i filtrowanie po status code
{service="api"} | json | status_code >= 500

# Top 10 najczęściej występujących błędów
topk(10, sum by (error_message) (
  count_over_time({app="api"} |= "ERROR" [24h])
))
```

## Korzyści z używania Lokiego z Grafaną

### 1. **Jednolity interfejs**
Metryki (Prometheus) i logi (Loki) w jednym miejscu

### 2. **Korelacja danych**
Możliwość przechodzenia z metryk do logów i odwrotnie

### 3. **Explore**
Interaktywne narzędzie do eksploracji logów

### 4. **Alerty**
Tworzenie alertów na podstawie wzorców w logach

### 5. **Dashboardy**
Wizualizacja logów w kontekście metryk i wykresów

## Kiedy wybrać Lokiego?

### ✅ Loki jest dobry dla:
- Zespołów już używających Grafany i Prometheusa
- Projektów wymagających niskokosztowego rozwiązania
- Środowisk Kubernetes/kontenerowych
- Prostych przypadków użycia logów
- Małych i średnich wdrożeń

### ❌ Loki może nie być odpowiedni dla:
- Wymagających zaawansowanych analiz tekstowych
- Potrzebujących złożonego wyszukiwania pełnotekstowego
- Istniejących wdrożeń ELK z dużymi inwestycjami
- Wymagających narzędzi analitycznych jak w Splunk

## Komponenty ekosystemu Lokiego

### 1. **Loki**
Główny serwer do przechowywania i zapytań

### 2. **Promtail**
Oficjalny agent do zbierania logów

### 3. **Grafana**
Interfejs użytkownika do wizualizacji

### 4. **LogCLI**
Narzędzie CLI do zapytań z terminala

### 5. **Fluent Bit**
Alternatywny agent do Promtail (lżejszy)

### 6. **Docker Driver**
Plugin do zbierania logów z kontenerów Docker

### 7. **Loki Canary**
Narzędzie do testowania i monitorowania Lokiego

## Rozpoczęcie pracy z Lokim

### Podstawowe kroki wdrożenia:

1. **Instalacja Loki** – serwer do przechowywania logów
2. **Instalacja Promtail** – agent do zbierania logów
3. **Konfiguracja źródeł logów** – określenie skąd zbierać logi
4. **Integracja z Grafaną** – podłączenie Loki jako Data Source
5. **Tworzenie zapytań** – eksploracja logów przez LogQL
6. **Budowa dashboardów** – wizualizacja logów

**Uwaga:** Szczegółowe instrukcje instalacji i konfiguracji znajdują się w kolejnych rozdziałach tego modułu.

## Podsumowanie

Loki to nowoczesne, wydajne i ekonomiczne rozwiązanie do zarządzania logami, które idealnie komponuje się z ekosystemem Grafany. Dzięki minimalistycznemu podejściu do indeksowania (tylko etykiety) oraz prostej architekturze, Loki stanowi doskonałą alternatywę dla tradycyjnych, kosztownych rozwiązań.

**Kluczowe zalety Lokiego:**
- Niskie koszty przechowywania i eksploatacji
- Prosta instalacja i konfiguracja
- Natywna integracja z Grafaną i Prometheusem
- Język zapytań LogQL inspirowany PromQL
- Idealne rozwiązanie dla środowisk kontenerowych

W kolejnych rozdziałach dowiesz się jak zainstalować i skonfigurować Lokiego, jak zbierać logi za pomocą Promtail, jak tworzyć zapytania LogQL oraz jak budować dashboardy w Grafanie oparte na logach.
