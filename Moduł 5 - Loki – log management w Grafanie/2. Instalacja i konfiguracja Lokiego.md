# Instalacja i konfiguracja Lokiego

Poniżej przedstawiono proces instalacji i konfiguracji Lokiego na systemie Ubuntu 24.04 LTS. Omówiono dwie metody instalacji: z pliku binarnego oraz przy użyciu Docker.

## Wymagania systemowe

### Minimalne wymagania:

- **System operacyjny**: Ubuntu 24.04 LTS (lub nowszy)
- **RAM**: Minimum 512 MB (zalecane 2 GB)
- **CPU**: 1 rdzeń (zalecane 2 rdzenie)
- **Dysk**: 10 GB wolnego miejsca
- **Sieć**: Dostęp do Internetu

### Wymagania dodatkowe:

- Uprawnienia **root** lub **sudo**
- Zainstalowany **systemd** (domyślnie w Ubuntu)
- Opcjonalnie: **Docker** (dla instalacji kontenerowej)

## Metody instalacji

Dostępne metody instalacji Lokiego:

1. **Binarka** – instalacja z gotowych plików binarnych
2. **Docker** – uruchomienie w kontenerze
3. **Kod źródłowy** – kompilacja z repozytorium GitHub
4. **Helm** – instalacja w Kubernetes

Poniżej szczegółowo omówiono instalację z binarki oraz Docker.

---

## Instalacja Lokiego z binarki

### Krok 1: Przygotowanie systemu

Aktualizacja systemu i instalacja niezbędnych narzędzi:

```bash
# Aktualizacja listy pakietów
sudo apt update

# Aktualizacja systemu
sudo apt upgrade -y

# Instalacja niezbędnych narzędzi
sudo apt install -y wget unzip curl
```

### Krok 2: Pobranie Lokiego

Pobranie najnowszej wersji Lokiego z oficjalnego repozytorium GitHub:

```bash
# Sprawdzenie najnowszej wersji: https://github.com/grafana/loki/releases
# Przykład dla wersji 2.9.3

# Pobranie binarki Lokiego
cd /tmp
wget https://github.com/grafana/loki/releases/download/v2.9.3/loki-linux-amd64.zip

# Rozpakowanie archiwum
unzip loki-linux-amd64.zip

# Przeniesienie binarki do /usr/local/bin
sudo mv loki-linux-amd64 /usr/local/bin/loki

# Nadanie uprawnień wykonywania
sudo chmod +x /usr/local/bin/loki
```

**Wyjaśnienie:**
- `/usr/local/bin/` – standardowa lokalizacja dla aplikacji instalowanych ręcznie
- `chmod +x` – nadaje uprawnienia do wykonywania pliku

### Krok 3: Weryfikacja instalacji

Sprawdzenie poprawności instalacji:

```bash
# Sprawdzenie wersji Lokiego
loki --version
```

Oczekiwany wynik:

```
loki, version 2.9.3 (branch: HEAD, revision: e24f5ab7a2b)
  build user:       root@buildkitsandbox
  build date:       2023-11-15T15:32:45Z
  go version:       go1.21.4
  platform:         linux/amd64
```

### Krok 4: Utworzenie użytkownika systemowego

Utworzenie dedykowanego użytkownika systemowego dla Lokiego:

```bash
# Utworzenie użytkownika systemowego loki
sudo useradd --system --no-create-home --shell /bin/false loki

# Utworzenie katalogów dla Lokiego
sudo mkdir -p /etc/loki
sudo mkdir -p /var/lib/loki

# Ustawienie właściciela katalogów
sudo chown -R loki:loki /etc/loki
sudo chown -R loki:loki /var/lib/loki
```

**Wyjaśnienie struktur katalogów:**
- `/etc/loki/` – pliki konfiguracyjne
- `/var/lib/loki/` – dane Lokiego (chunks, indeksy)

### Krok 5: Utworzenie pliku konfiguracyjnego

Podstawowy plik konfiguracyjny Lokiego:

```bash
sudo nano /etc/loki/loki-config.yaml
```

Zawartość pliku konfiguracyjnego:

```yaml
# Podstawowa konfiguracja Lokiego
auth_enabled: false

# Konfiguracja serwera HTTP
server:
  http_listen_port: 3100
  grpc_listen_port: 9096
  log_level: info

# Konfiguracja ingester (komponent przyjmujący logi)
ingester:
  lifecycler:
    address: 127.0.0.1
    ring:
      kvstore:
        store: inmemory
      replication_factor: 1
  chunk_idle_period: 5m
  chunk_retain_period: 30s
  max_transfer_retries: 0

# Konfiguracja schematu przechowywania danych
schema_config:
  configs:
    - from: 2020-10-24
      store: boltdb-shipper
      object_store: filesystem
      schema: v11
      index:
        prefix: index_
        period: 24h

# Konfiguracja przechowywania danych
storage_config:
  boltdb_shipper:
    active_index_directory: /var/lib/loki/index
    cache_location: /var/lib/loki/cache
    shared_store: filesystem
  filesystem:
    directory: /var/lib/loki/chunks

# Limity i ograniczenia
limits_config:
  reject_old_samples: true
  reject_old_samples_max_age: 168h
  ingestion_rate_mb: 10
  ingestion_burst_size_mb: 20

# Konfiguracja kompaktora (czyszczenie starych danych)
compactor:
  working_directory: /var/lib/loki/compactor
  shared_store: filesystem

# Retention (opcjonalne - usuwanie starych logów)
chunk_store_config:
  max_look_back_period: 0s

table_manager:
  retention_deletes_enabled: false
  retention_period: 0s
```

**Wyjaśnienie kluczowych parametrów:**

- **auth_enabled**: Wyłączenie autentykacji (środowisko testowe)
- **http_listen_port**: Port HTTP dla API Lokiego. Domyślnie: 3100.
- **grpc_listen_port**: Port gRPC dla komunikacji z agentami. Domyślnie: 9096.
- **replication_factor**: Liczba replik danych. Domyślnie: 1 (brak replikacji).
- **store**: Typ bazy danych dla indeksów. `boltdb-shipper` to wbudowana baza danych.
- **object_store**: Miejsce przechowywania danych. `filesystem` oznacza dysk lokalny.
- **ingestion_rate_mb**: Limit szybkości przyjmowania logów w MB/s. Domyślnie: 10.
- **ingestion_burst_size_mb**: Maksymalny rozmiar burstu. Domyślnie: 20.

### Krok 6: Utworzenie usługi systemd

Plik usługi systemd dla Lokiego:

```bash
sudo nano /etc/systemd/system/loki.service
```

Zawartość pliku usługi:

```ini
[Unit]
Description=Loki Log Aggregation System
Documentation=https://grafana.com/docs/loki/latest/
After=network-online.target
Wants=network-online.target

[Service]
Type=simple
User=loki
Group=loki
ExecStart=/usr/local/bin/loki -config.file=/etc/loki/loki-config.yaml
Restart=always
RestartSec=5
StandardOutput=journal
StandardError=journal
SyslogIdentifier=loki

# Ograniczenia zasobów
LimitNOFILE=65536
LimitNPROC=4096

[Install]
WantedBy=multi-user.target
```

**Wyjaśnienie opcji usługi:**

- **Type**: Typ uruchomienia procesu. `simple` oznacza proces działający w foreground.
- **User/Group**: Użytkownik i grupa systemowa dla procesu.
- **ExecStart**: Komenda uruchamiająca Lokiego z określonym plikiem konfiguracyjnym.
- **Restart**: Polityka restartu. `always` oznacza automatyczny restart po awarii.
- **RestartSec**: Czas oczekiwania przed restartem w sekundach. Domyślnie: 5.
- **LimitNOFILE**: Limit otwartych plików. Domyślnie: 65536.
- **LimitNPROC**: Limit procesów potomnych. Domyślnie: 4096.

### Krok 7: Uruchomienie usługi Loki

Przeładowanie konfiguracji systemd i uruchomienie usługi:

```bash
# Przeładowanie konfiguracji systemd
sudo systemctl daemon-reload

# Uruchomienie usługi Loki
sudo systemctl start loki

# Włączenie automatycznego uruchamiania przy starcie systemu
sudo systemctl enable loki

# Sprawdzenie statusu usługi
sudo systemctl status loki
```

Oczekiwany wynik:

```
● loki.service - Loki Log Aggregation System
     Loaded: loaded (/etc/systemd/system/loki.service; enabled; vendor preset: enabled)
     Active: active (running) since Wed 2026-02-05 10:30:15 UTC; 5s ago
       Docs: https://grafana.com/docs/loki/latest/
   Main PID: 12345 (loki)
      Tasks: 10 (limit: 4096)
     Memory: 45.2M
        CPU: 234ms
     CGroup: /system.slice/loki.service
             └─12345 /usr/local/bin/loki -config.file=/etc/loki/loki-config.yaml
```

### Krok 8: Weryfikacja działania

Sprawdzenie dostępności endpointów Lokiego:

```bash
# Sprawdzenie endpoint /ready
curl http://localhost:3100/ready

# Sprawdzenie metryk Lokiego
curl http://localhost:3100/metrics

# Sprawdzenie konfiguracji
curl http://localhost:3100/config
```

Poprawna odpowiedź to kod HTTP 200.

### Krok 9: Przegląd logów

Analiza logów Lokiego w systemd journal:

```bash
# Ostatnie 50 linii logów
sudo journalctl -u loki -n 50

# Logi w czasie rzeczywistym
sudo journalctl -u loki -f

# Logi z ostatniej godziny
sudo journalctl -u loki --since "1 hour ago"

# Logi z określonego okresu
sudo journalctl -u loki --since "2026-02-05 10:00:00" --until "2026-02-05 11:00:00"
```

---

## Instalacja Lokiego przez Docker

Alternatywna metoda instalacji z użyciem kontenera Docker.

### Krok 1: Instalacja Docker

Instalacja Docker Engine na Ubuntu 24.04:

```bash
# Instalacja wymaganych pakietów
sudo apt install -y ca-certificates curl gnupg
sudo install -m 0755 -d /etc/apt/keyrings

# Dodanie klucza GPG Docker
curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /etc/apt/keyrings/docker.gpg
sudo chmod a+r /etc/apt/keyrings/docker.gpg

# Dodanie repozytorium Docker
echo \
  "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu \
  $(. /etc/os-release && echo "$VERSION_CODENAME") stable" | \
  sudo tee /etc/apt/sources.list.d/docker.list > /dev/null

# Aktualizacja i instalacja Docker
sudo apt update
sudo apt install -y docker-ce docker-ce-cli containerd.io

# Weryfikacja instalacji
sudo docker --version
```

### Krok 2: Przygotowanie struktury katalogów

Utworzenie katalogów dla danych i konfiguracji:

```bash
# Utworzenie katalogów dla Lokiego
mkdir -p ~/loki-docker/config
mkdir -p ~/loki-docker/data

# Przejście do katalogu roboczego
cd ~/loki-docker
```

### Krok 3: Utworzenie pliku konfiguracyjnego

Plik konfiguracyjny dla kontenera Docker:

```bash
nano ~/loki-docker/config/loki-config.yaml
```

Zawartość pliku konfiguracyjnego:

```yaml
auth_enabled: false

server:
  http_listen_port: 3100
  grpc_listen_port: 9096
  log_level: info

ingester:
  lifecycler:
    address: 127.0.0.1
    ring:
      kvstore:
        store: inmemory
      replication_factor: 1
  chunk_idle_period: 5m
  chunk_retain_period: 30s
  max_transfer_retries: 0

schema_config:
  configs:
    - from: 2020-10-24
      store: boltdb-shipper
      object_store: filesystem
      schema: v11
      index:
        prefix: index_
        period: 24h

storage_config:
  boltdb_shipper:
    active_index_directory: /loki/index
    cache_location: /loki/cache
    shared_store: filesystem
  filesystem:
    directory: /loki/chunks

limits_config:
  reject_old_samples: true
  reject_old_samples_max_age: 168h
  ingestion_rate_mb: 10
  ingestion_burst_size_mb: 20

compactor:
  working_directory: /loki/compactor
  shared_store: filesystem

chunk_store_config:
  max_look_back_period: 0s

table_manager:
  retention_deletes_enabled: false
  retention_period: 0s
```

**Uwaga:** Ścieżki w kontenerze używają `/loki/` zamiast `/var/lib/loki/`

### Krok 4: Uruchomienie kontenera Loki

Uruchomienie Lokiego jako kontenera Docker:

```bash
# Uruchomienie kontenera Loki
docker run -d \
  --name=loki \
  --restart=unless-stopped \
  -p 3100:3100 \
  -p 9096:9096 \
  -v ~/loki-docker/config:/etc/loki \
  -v ~/loki-docker/data:/loki \
  grafana/loki:2.9.3 \
  -config.file=/etc/loki/loki-config.yaml
```

**Wyjaśnienie parametrów:**

- `-d`: Uruchomienie w trybie detached (w tle).
- `--name=loki`: Nazwa kontenera.
- `--restart=unless-stopped`: Automatyczny restart kontenera po restarcie systemu.
- `-p 3100:3100`: Mapowanie portu HTTP hosta na port kontenera.
- `-p 9096:9096`: Mapowanie portu gRPC.
- `-v ~/loki-docker/config:/etc/loki`: Montowanie katalogu konfiguracji z hosta do kontenera.
- `-v ~/loki-docker/data:/loki`: Montowanie katalogu danych.
- `grafana/loki:2.9.3`: Obraz Docker z określoną wersją Lokiego.
- `-config.file=/etc/loki/loki-config.yaml`: Ścieżka do pliku konfiguracyjnego w kontenerze.

### Krok 5: Weryfikacja kontenera

Sprawdzenie działania kontenera:

```bash
# Sprawdzenie statusu kontenera
docker ps | grep loki

# Wyświetlenie logów kontenera
docker logs loki

# Wyświetlenie logów w czasie rzeczywistym
docker logs -f loki

# Sprawdzenie endpoint /ready
curl http://localhost:3100/ready

# Sprawdzenie metryk
curl http://localhost:3100/metrics
```

### Krok 6: Zarządzanie kontenerem

Podstawowe operacje na kontenerze:

```bash
# Zatrzymanie kontenera
docker stop loki

# Uruchomienie kontenera
docker start loki

# Restart kontenera
docker restart loki

# Wyświetlenie statystyk zasobów
docker stats loki

# Usunięcie kontenera
docker rm -f loki
```

---

## Zaawansowana konfiguracja

### 1. Konfiguracja retencji logów

Konfiguracja automatycznego usuwania starych logów:

```yaml
# Dodanie do limits_config
limits_config:
  retention_period: 744h  # 31 dni

# Włączenie retencji w table_manager
table_manager:
  retention_deletes_enabled: true
  retention_period: 744h
```

**Wyjaśnienie:**
- **retention_period**: Okres przechowywania logów w godzinach.
- **retention_deletes_enabled**: Włączenie automatycznego usuwania starych logów.

### 2. Włączenie autentykacji

Konfiguracja multi-tenancy z autentykacją:

```yaml
auth_enabled: true

server:
  http_listen_port: 3100
  grpc_listen_port: 9096

# Wymagany nagłówek HTTP: X-Scope-OrgID
# Przykład: X-Scope-OrgID: tenant1
```

**Wyjaśnienie:**

Każde żądanie do Lokiego musi zawierać nagłówek `X-Scope-OrgID` identyfikujący tenant (organizację).

Przykład użycia:

```bash
curl -H "X-Scope-OrgID: tenant1" http://localhost:3100/loki/api/v1/query
```

### 3. Optymalizacja wydajności

Konfiguracja dla większych obciążeń:

```yaml
# Zwiększone limity dla większych obciążeń
limits_config:
  ingestion_rate_mb: 50
  ingestion_burst_size_mb: 100
  max_streams_per_user: 10000
  max_global_streams_per_user: 100000

# Optymalizacja ingester
ingester:
  chunk_encoding: snappy
  chunk_target_size: 1572864  # 1.5 MB
  max_chunk_age: 2h
```

**Wyjaśnienie parametrów:**

- **ingestion_rate_mb**: Maksymalna szybkość przyjmowania logów w MB/s.
- **ingestion_burst_size_mb**: Maksymalny rozmiar burstu w MB.
- **max_streams_per_user**: Maksymalna liczba unikalnych strumieni na użytkownika.
- **chunk_encoding**: Algorytm kompresji chunków. `snappy` zapewnia szybką kompresję.
- **chunk_target_size**: Docelowy rozmiar chunka w bajtach.
- **max_chunk_age**: Maksymalny wiek chunka przed jego zamknięciem.

### 4. Konfiguracja z zewnętrznym storage (S3)

Użycie S3-compatible storage dla większych wdrożeń:

```yaml
storage_config:
  aws:
    s3: s3://region/bucket_name
    access_key_id: ${AWS_ACCESS_KEY_ID}
    secret_access_key: ${AWS_SECRET_ACCESS_KEY}
    bucketnames: loki-chunks
  boltdb_shipper:
    active_index_directory: /loki/index
    cache_location: /loki/cache
    shared_store: s3
```

**Wyjaśnienie:**

Zewnętrzne storage (S3, GCS, Azure) umożliwia:
- Większą skalowalność przechowywania
- Oddzielenie storage od compute
- Łatwiejsze skalowanie poziome

---

## Zabezpieczenie instalacji

### 1. Konfiguracja firewalla (UFW)

Ograniczenie dostępu do Lokiego za pomocą firewalla:

```bash
# Włączenie UFW
sudo ufw enable

# Zezwolenie na port 3100 tylko z określonej sieci
sudo ufw allow from 10.0.0.0/24 to any port 3100

# Zezwolenie na port 9096 dla agentów Promtail
sudo ufw allow from 10.0.0.0/24 to any port 9096

# Sprawdzenie reguł
sudo ufw status numbered

# Zezwolenie na SSH (jeśli jeszcze nie dodano)
sudo ufw allow 22/tcp
```

**Wyjaśnienie:**

Reguły firewalla ograniczają dostęp do Lokiego tylko z określonej sieci (np. 10.0.0.0/24).

### 2. Konfiguracja reverse proxy (nginx)

Zabezpieczenie dostępu do Lokiego przez nginx:

```bash
# Instalacja nginx
sudo apt install -y nginx

# Utworzenie pliku konfiguracyjnego
sudo nano /etc/nginx/sites-available/loki
```

Zawartość pliku konfiguracyjnego nginx:

```nginx
server {
    listen 80;
    server_name loki.example.com;

    # Ograniczenie dostępu do określonych IP
    allow 10.0.0.0/24;
    deny all;

    location / {
        proxy_pass http://localhost:3100;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}
```

Aktywacja konfiguracji:

```bash
# Włączenie konfiguracji
sudo ln -s /etc/nginx/sites-available/loki /etc/nginx/sites-enabled/

# Sprawdzenie składni
sudo nginx -t

# Przeładowanie nginx
sudo systemctl reload nginx
```

### 3. Konfiguracja SSL/TLS z Let's Encrypt

Zabezpieczenie połączenia SSL/TLS:

```bash
# Instalacja certbot
sudo apt install -y certbot python3-certbot-nginx

# Uzyskanie certyfikatu SSL
sudo certbot --nginx -d loki.example.com

# Automatyczne odnowienie certyfikatu (certbot dodaje cronjob automatycznie)
sudo certbot renew --dry-run
```

Certbot automatycznie modyfikuje konfigurację nginx, dodając sekcję SSL:

```nginx
server {
    listen 443 ssl;
    server_name loki.example.com;

    ssl_certificate /etc/letsencrypt/live/loki.example.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/loki.example.com/privkey.pem;

    location / {
        proxy_pass http://localhost:3100;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}
```

---

## Troubleshooting

### Problem 1: Loki nie startuje

Diagnostyka problemu:

```bash
# Sprawdzenie logów systemd
sudo journalctl -u loki -n 100 --no-pager

# Sprawdzenie uprawnień do katalogów
ls -la /var/lib/loki
ls -la /etc/loki

# Weryfikacja składni pliku konfiguracyjnego
loki -config.file=/etc/loki/loki-config.yaml -verify-config

# Sprawdzenie czy port nie jest zajęty
sudo lsof -i :3100
```

Typowe przyczyny:
- Błędna składnia w pliku konfiguracyjnym
- Brak uprawnień do katalogów
- Zajęty port 3100

### Problem 2: Port już zajęty

Identyfikacja procesu zajmującego port:

```bash
# Sprawdzenie procesu używającego portu 3100
sudo lsof -i :3100

# Alternatywnie z użyciem ss
sudo ss -tlnp | grep 3100

# Zatrzymanie procesu zajmującego port
sudo kill -9 <PID>

# Lub zmiana portu w konfiguracji Lokiego
```

### Problem 3: Brak miejsca na dysku

Analiza wykorzystania dysku:

```bash
# Sprawdzenie użycia dysku
df -h /var/lib/loki

# Sprawdzenie rozmiaru katalogów Lokiego
du -sh /var/lib/loki/*

# Szczegółowa analiza rozmiaru
du -h /var/lib/loki | sort -h

# Sprawdzenie liczby plików
find /var/lib/loki -type f | wc -l
```

Rozwiązania:
- Konfiguracja retencji (automatyczne usuwanie starych logów)
- Zwiększenie przestrzeni dyskowej
- Przeniesienie danych na większy dysk
- Użycie zewnętrznego storage (S3)

### Problem 4: Wysoka latencja zapytań

Diagnoza wydajności:

```bash
# Sprawdzenie metryk wydajności
curl http://localhost:3100/metrics | grep loki_ingester

# Sprawdzenie metryk zapytań
curl http://localhost:3100/metrics | grep loki_query_duration

# Sprawdzenie liczby strumieni
curl http://localhost:3100/metrics | grep loki_ingester_streams

# Monitorowanie zasobów systemowych
top
htop
```

Rozwiązania:
- Zwiększenie zasobów (RAM, CPU)
- Optymalizacja zapytań LogQL
- Zmniejszenie liczby etykiet (kardynalności)
- Konfiguracja cache

### Problem 5: Błędy ingestion rate limit

Komunikat błędu:

```
ingestion rate limit exceeded for user (limit: 10MB/sec) while attempting to ingest '15' lines totaling '2MB'
```

Rozwiązanie:

```yaml
# Zwiększenie limitów w konfiguracji
limits_config:
  ingestion_rate_mb: 50
  ingestion_burst_size_mb: 100
```

```bash
# Restart Lokiego po zmianie konfiguracji
sudo systemctl restart loki
```

---

## Testowanie instalacji

### Test 1: Wysłanie testowego logu przez API

Wysłanie logu do Lokiego za pomocą curl:

```bash
# Wysłanie testowego logu
curl -X POST http://localhost:3100/loki/api/v1/push \
  -H "Content-Type: application/json" \
  -d '{
    "streams": [
      {
        "stream": {
          "job": "test",
          "host": "localhost"
        },
        "values": [
          ["'$(date +%s)000000000'", "Test log message from curl"]
        ]
      }
    ]
  }'
```

**Wyjaśnienie formatu:**

- **streams**: Tablica strumieni logów
- **stream**: Etykiety identyfikujące strumień (job, host)
- **values**: Tablica zawierająca pary [timestamp, message]
- Timestamp w formacie nanosekund Unix epoch

### Test 2: Zapytanie o logi

Pobranie logów za pomocą API:

```bash
# Zapytanie LogQL przez API
curl -G -s "http://localhost:3100/loki/api/v1/query" \
  --data-urlencode 'query={job="test"}' \
  --data-urlencode 'limit=10' | jq
```

**Uwaga:** Wymaga zainstalowanego `jq`: `sudo apt install jq`

### Test 3: Zapytanie range query

Zapytanie o logi z określonego przedziału czasowego:

```bash
# Range query - ostatnie 5 minut
curl -G -s "http://localhost:3100/loki/api/v1/query_range" \
  --data-urlencode 'query={job="test"}' \
  --data-urlencode 'start='$(date -d '5 minutes ago' +%s)000000000 \
  --data-urlencode 'end='$(date +%s)000000000 \
  --data-urlencode 'limit=100' | jq
```

### Test 4: Sprawdzenie metryk

Analiza metryk Lokiego:

```bash
# Metryki ingester
curl -s http://localhost:3100/metrics | grep loki_ingester_streams_created_total

# Metryki zapytań
curl -s http://localhost:3100/metrics | grep loki_query_duration_seconds

# Metryki otrzymanych logów
curl -s http://localhost:3100/metrics | grep loki_distributor_lines_received_total
```

### Test 5: Sprawdzenie statusu komponentów

```bash
# Status wszystkich komponentów
curl -s http://localhost:3100/services | jq

# Lista labelów
curl -s http://localhost:3100/loki/api/v1/labels | jq

# Wartości konkretnej etykiety
curl -s http://localhost:3100/loki/api/v1/label/job/values | jq
```

---

## Monitorowanie Lokiego

### Metryki Prometheus

Loki eksponuje metryki w formacie Prometheus na endpoint `/metrics`.

Kluczowe metryki do monitorowania:

| Metryka | Opis |
|---------|------|
| `loki_ingester_streams_created_total` | Liczba utworzonych strumieni |
| `loki_distributor_lines_received_total` | Liczba otrzymanych linii logów |
| `loki_distributor_bytes_received_total` | Liczba otrzymanych bajtów |
| `loki_ingester_chunks_stored_total` | Liczba przechowywanych chunków |
| `loki_query_duration_seconds` | Czas wykonywania zapytań |
| `loki_request_duration_seconds` | Czas przetwarzania żądań HTTP |

### Konfiguracja Prometheusa dla Lokiego

Fragment konfiguracji `prometheus.yml`:

```yaml
scrape_configs:
  - job_name: 'loki'
    static_configs:
      - targets: ['localhost:3100']
    scrape_interval: 15s
```

---

## Podsumowanie

Instalacja i konfiguracja Lokiego została omówiona w dwóch wariantach:
- Instalacja z binarki jako usługa systemd
- Instalacja w kontenerze Docker

**Kluczowe lokalizacje:**

| Lokalizacja | Opis |
|-------------|------|
| `/usr/local/bin/loki` | Binarka Lokiego |
| `/etc/loki/loki-config.yaml` | Plik konfiguracyjny |
| `/var/lib/loki/` | Katalog z danymi |
| `/etc/systemd/system/loki.service` | Plik usługi systemd |

**Podstawowe komendy:**

```bash
# Zarządzanie usługą
sudo systemctl status loki
sudo systemctl start loki
sudo systemctl stop loki
sudo systemctl restart loki

# Przegląd logów
sudo journalctl -u loki -f

# Weryfikacja działania
curl http://localhost:3100/ready
curl http://localhost:3100/metrics
```

**Porty:**

- **3100** – HTTP API (zapytania, push logów)
- **9096** – gRPC (komunikacja z Promtail)

**Następne kroki:**

- Instalacja i konfiguracja Promtail (agent zbierający logi)
- Integracja z Grafaną
- Tworzenie zapytań LogQL
- Budowa dashboardów
