
Plik `prometheus.yml` jest głównym plikiem konfiguracyjnym Prometheusa, który definiuje sposób zbierania metryk, częstotliwość odpytywania oraz cele monitorowania. Dobrze skonfigurowany plik konfiguracyjny jest kluczowy dla efektywnego działania systemu monitoringu.

## Struktura pliku prometheus.yml

Plik konfiguracyjny Prometheusa składa się z kilku głównych sekcji:

### 1. **global** – Konfiguracja globalna

Sekcja `global` definiuje ustawienia, które są stosowane globalnie dla wszystkich zadań zbierania danych, chyba że zostaną nadpisane w poszczególnych zadaniach.

```yaml
global:
  scrape_interval: 15s        # Częstotliwość zbierania metryk
  evaluation_interval: 15s    # Częstotliwość oceny reguł
  scrape_timeout: 10s         # Timeout dla pojedynczego scrape
  external_labels:            # Etykiety dodawane do wszystkich metryk
    cluster: 'production'
    region: 'eu-central'
```

**Parametry sekcji global:**

- **scrape_interval**: Określa, co ile sekund Prometheus odpytuje cele (targets). Domyślnie: 1m.
- **evaluation_interval**: Określa, jak często Prometheus ocenia reguły alertów i reguły nagrywania. Domyślnie: 1m.
- **scrape_timeout**: Maksymalny czas oczekiwania na odpowiedź od celu. Domyślnie: 10s.
- **external_labels**: Dodatkowe etykiety dołączane do wszystkich metryk i alertów, przydatne przy federacji Prometheusa.

---

### 2. **rule_files** – Pliki z regułami

Sekcja `rule_files` wskazuje na pliki zawierające reguły alertów i reguły nagrywania (recording rules).

```yaml
rule_files:
  - "/etc/prometheus/rules/*.yml"
  - "/etc/prometheus/alerts/*.yml"
```

Pliki reguł umożliwiają:
- **Reguły alertów**: Definiowanie warunków, które wywołują alerty.
- **Reguły nagrywania**: Prekalkulację złożonych zapytań PromQL w celu optymalizacji wydajności.

#### Czym są pliki z regułami 

Pliki z regułami to dokumenty, które mówią Prometheusowi: **"Jeśli zobaczysz tę sytuację, zrób tamto"**.

**Dwa typy reguł:**

1. **Reguły alertów (alerting rules)**
   - To instrukcje mówiące "kiedy wysłać alarm"
   - Przykład: "Jeśli serwer używa więcej niż 90% pamięci przez 5 minut, wyślij alert"
   - Przykład: "Jeśli strona internetowa nie odpowiada przez 30 sekund, powiadom administratora"
   
2. **Reguły nagrywania (recording rules)**  
   - To gotowe obliczenia, które Prometheus wykonuje z góry i zapisuje
   - Przykład: zamiast każdorazowo liczyć "średnie użycie CPU z ostatnich 24h", Prometheus co godzinę to liczy i zapisuje wynik
   - Dzięki temu wykresy w Grafanie ładują się szybciej (nie muszą liczyć na bieżąco)

**Dlaczego trzymamy to w osobnych plikach?**

Zamiast trzymać setki reguł w jednym wielkim pliku `prometheus.yml`, organizujemy je w osobne pliki:
```
/etc/prometheus/rules/
├── cpu_alerts.yml          ← alerty związane z procesorem
├── memory_alerts.yml       ← alerty związane z pamięcią
├── disk_alerts.yml         ← alerty związane z dyskami
└── recording_rules.yml     ← prekalkulowane metryki
```

To tak jak segregowanie dokumentów w teczkach - łatwiej się w tym odnaleźć.

**Praktyczny przykład reguły alertu:**

```yaml
groups:
  - name: server_alerts
    rules:
      - alert: HighMemoryUsage
        expr: node_memory_used_percent > 90
        for: 5m
        labels:
          severity: critical
        annotations:
          summary: "Serwer {{ $labels.instance }} używa {{ $value }}% pamięci"
```

To oznacza: "Jeśli pamięć przekroczy 90% i tak zostanie przez 5 minut, wyślij alert o krytycznej wadze z informacją który serwer i ile dokładnie używa pamięci".

#### ⚠️ Ważne: Gdzie trafiają te alerty?

Częste pytanie: **"Jeśli utworzę taką regułę, to dostanę email lub SMS?"**

**Odpowiedź: NIE - Prometheus sam nie wysyła żadnych powiadomień!**

Prometheus tylko **wykrywa** problemy i zmienia stan alertu na "Firing" (aktywny). Alerty są widoczne w interfejsie webowym Prometheusa pod adresem `http://localhost:9090/alerts`, ale **nikt nie dostanie automatycznie żadnej wiadomości**.

**Żeby otrzymać powiadomienie potrzebujesz:**

```
┌──────────────┐
│  PROMETHEUS  │  ← Wykrywa problemy (reguły)
│              │  ← Zmienia stan na "Firing"
└──────┬───────┘
       │
       │ Przekazuje alerty
       ▼
┌──────────────┐
│ ALERTMANAGER │  ← Wysyła powiadomienia
│              │  ← Email, Slack, SMS, PagerDuty
└──────────────┘
```

**Alertmanager** to osobny komponent, który:
- Odbiera alerty od Prometheusa
- Wysyła powiadomienia (email, Slack, SMS, webhook)
- Grupuje alerty (żeby nie dostać 100 emaili jednocześnie)
- Deduplikuje (żeby nie dostawać tego samego alertu wielokrotnie)
- Pozwala na różne reguły routingu (alerty krytyczne na telefon, ostrzeżenia na email)

**Przykład połączenia Prometheusa z Alertmanagerem:**

W pliku `prometheus.yml` dodaj sekcję:

```yaml
alerting:
  alertmanagers:
    - static_configs:
        - targets:
            - 'localhost:9093'  # Adres Alertmanagera
```

Dopiero wtedy Prometheus będzie przekazywać alerty do Alertmanagera, a ten wyśle powiadomienia według swojej konfiguracji.

**Podsumowanie prostymi słowami:**
- **Prometheus** = czujnik dymu (wykrywa problem)
- **Alertmanager** = syrena alarmowa (informuje ludzi)
- Bez Alertmanagera alerty są tylko w interfejsie Prometheusa

---





## Przykładowy pełny plik prometheus.yml

```yaml
# Konfiguracja globalna
global:
  scrape_interval: 15s
  evaluation_interval: 15s
  scrape_timeout: 10s
  external_labels:
    monitor: 'production-monitoring'
    datacenter: 'dc1'

# Pliki z regułami alertów i recording rules
rule_files:
  - "/etc/prometheus/rules/alerts.yml"
  - "/etc/prometheus/rules/recording.yml"

# Konfiguracja Alertmanagera
alerting:
  alertmanagers:
    - static_configs:
        - targets:
            - 'alertmanager:9093'

# Konfiguracja zbierania metryk
scrape_configs:
  # Monitorowanie samego Prometheusa
  - job_name: 'prometheus'
    static_configs:
      - targets: ['localhost:9090']

  # Monitorowanie serwerów za pomocą Node Exporter
  - job_name: 'node_exporter'
    scrape_interval: 30s
    static_configs:
      - targets:
          - 'server1:9100'
          - 'server2:9100'
          - 'server3:9100'
        labels:
          env: 'production'
          type: 'linux'

  # Monitorowanie aplikacji webowej
  - job_name: 'webapp'
    scrape_interval: 15s
    metrics_path: '/actuator/prometheus'
    static_configs:
      - targets:
          - 'webapp1:8080'
          - 'webapp2:8080'
        labels:
          app: 'my-webapp'

  # Monitorowanie bazy danych PostgreSQL
  - job_name: 'postgres'
    static_configs:
      - targets:
          - 'postgres-exporter:9187'
        labels:
          database: 'postgres'
```

---

## Weryfikacja konfiguracji

Przed uruchomieniem Prometheusa warto zweryfikować poprawność pliku konfiguracyjnego:

```bash
promtool check config /etc/prometheus/prometheus.yml
```

Sprawdzenie składni reguł:

```bash
promtool check rules /etc/prometheus/rules/*.yml
```

---

