# Alertmanager

## Czym jest Alertmanager?

Alertmanager to komponent który odbiera alerty od Prometheusa i przekształca je w konkretne powiadomienia - wysyła emaile, wiadomości na Slack, SMS-y czy wywołuje webhoki. Prometheus sam tylko wykrywa problemy i zmienia stan alertu na "Firing", ale to Alertmanager decyduje kto, kiedy i w jaki sposób zostanie o tym powiadomiony. Dzięki niemu możesz grupować alerty (żeby nie dostać 50 emaili naraz), ustalać priorytety (krytyczne alerty na telefon, ostrzeżenia na email) oraz wyciszać powtarzające się powiadomienia. Bez Alertmanagera alerty są tylko widoczne w interfejsie Prometheusa - nikt nie dostanie automatycznego powiadomienia.

---

## Praktyczne ćwiczenie: Pierwszy alert w Prometheusie

Na początek pokażemy jak stworzyć prosty alert w samym Prometheusie (bez Alertmanagera). Alert będzie widoczny w interfejsie webowym - to dobry sposób na naukę i testowanie reguł alertów.

### Krok 1: Utworzenie pliku z regułami alertów

Utwórz plik `/etc/prometheus/alerts.yml`:

```bash
sudo nano /etc/prometheus/alerts.yml
```

Wklej następującą zawartość:

```yaml
groups:
  - name: system-alerts
    rules:
      - alert: RAMAbove5Percent
        expr: 100 * (1 - (node_memory_MemAvailable_bytes / node_memory_MemTotal_bytes)) > 5
        for: 2m
        labels:
          severity: warning
        annotations:
          summary: "RAM powyżej 5%"
          description: "Zużycie RAM przekroczyło 5% na {{ $labels.instance }}"
```

**Wyjaśnienie:**
- `alert: RAMAbove5Percent` - nazwa alertu (widoczna w interfejsie)
- `expr: ...` - wyrażenie PromQL sprawdzające użycie RAM
  - Oblicza procent zajętej pamięci
  - Sprawdza czy przekroczyło 5% (bardzo niski próg, więc alert szybko się pojawi)
- `for: 2m` - alert aktywuje się dopiero gdy warunek trwa 2 minuty
- `severity: warning` - poziom ważności (warning / critical)
- `annotations` - dodatkowe informacje wyświetlane w alercie
  - `{{ $labels.instance }}` - pokazuje nazwę serwera

**Dlaczego 5%?**  
To celowo bardzo niski próg - chcemy żeby alert się szybko pojawił podczas szkolenia. W produkcji ustawiłbyś 80-90%.

### Krok 2: Dodanie pliku do konfiguracji Prometheusa

Edytuj główny plik konfiguracyjny:

```bash
sudo nano /etc/prometheus/prometheus.yml
```

Dodaj lub odkomentuj sekcję `rule_files`:

```yaml
global:
  scrape_interval: 15s
  evaluation_interval: 15s

# Dodaj tę sekcję
rule_files:
  - "/etc/prometheus/alerts.yml"

scrape_configs:
  # ... reszta konfiguracji
```

**Ważne:** Sprawdź wcięcia (yaml wymaga spacji, nie tabulatorów)!

### Krok 3: Weryfikacja składni

Przed restartem sprawdź czy plik jest poprawny:

```bash
# Sprawdzenie pliku z regułami
promtool check rules /etc/prometheus/alerts.yml

# Sprawdzenie głównej konfiguracji
promtool check config /etc/prometheus/prometheus.yml
```

**Oczekiwany wynik:**
```
Checking /etc/prometheus/alerts.yml
  SUCCESS: 1 rules found

Checking /etc/prometheus/prometheus.yml
  SUCCESS: 1 rule files found
```

### Krok 4: Restart Prometheusa

```bash
sudo systemctl restart prometheus

# Sprawdź czy usługa działa
sudo systemctl status prometheus
```
### Krok 5: Weryfikacja w interfejsie webowym

1. Otwórz w przeglądarce: `http://localhost:9090`

2. Przejdź do zakładki **Alerts** (w górnym menu)

3. Powinieneś zobaczyć:
   - Alert `RAMAbove5Percent` 
   - Stan: **Inactive** (zielony) lub **Pending** (żółty) lub **Firing** (czerwony)

**Stany alertu:**
- **Inactive** (zielony) - warunek nie jest spełniony, wszystko OK
- **Pending** (żółty) - warunek jest spełniony, ale nie minęły jeszcze 2 minuty z `for: 2m`
- **Firing** (czerwony) - alert aktywny! Warunek trwa dłużej niż 2 minuty

4. Kliknij w nazwę alertu aby zobaczyć szczegóły:
   - Aktualna wartość wyrażenia
   - Etykiety
   - Adnotacje (summary i description)

### Krok 6: Test alertu w Graph

Możesz przetestować wyrażenie PromQL przed uruchomieniem alertu:

1. Przejdź do zakładki **Graph**

2. Wklej wyrażenie:
   ```
   100 * (1 - (node_memory_MemAvailable_bytes / node_memory_MemTotal_bytes))
   ```

3. Kliknij **Execute**

4. Zobaczysz aktualny procent użycia RAM - jeśli jest powyżej 5%, alert powinien się wkrótce pojawić

**Przykładowy wynik:**
```
{instance="localhost:9100", job="node_exporter"}  23.45
```
To oznacza że RAM jest zajęty w 23.45% - alert powinien być aktywny.

