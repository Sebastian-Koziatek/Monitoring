# Node Exporter

Node Exporter to oficjalny eksporter Prometheusa, który udostępnia metryki systemowe Linux. Umożliwia zbieranie szczegółowych informacji o zasobach systemowych takich jak CPU, pamięć RAM, dyski, sieć, system plików i wiele innych.

## Czym jest Node Exporter?

Node Exporter jest jednym z najpopularniejszych eksporterów w ekosystemie Prometheusa. Jego głównym zadaniem jest:

- **Eksport metryk systemowych** – zbiera dane bezpośrednio z systemu operacyjnego Linux
- **Format Prometheus** – udostępnia metryki w formacie zrozumiałym dla Prometheusa przez endpoint HTTP
- **Zerowa konfiguracja** – działa od razu po uruchomieniu z sensownymi domyślnymi ustawieniami
- **Modularna architektura** – pozwala włączać/wyłączać poszczególne kollektory metryk

## Architektura Node Exporter

```
┌─────────────────────────────────────────┐
│         System Linux (Ubuntu)           │
│                                         │
│  ┌──────────┐  ┌──────────┐  ┌──────┐   │
│  │   CPU    │  │   RAM    │  │ Disk │   │
│  └────┬─────┘  └────┬─────┘  └───┬──┘   │
│       │             │            │      │
│       └─────────────┼────────────┘      │
│                     │                   │
│            ┌────────▼────────┐          │
│            │  Node Exporter  │          │
│            │  (port 9100)    │          │
│            └────────┬────────┘          │
└─────────────────────┼───────────────────┘
                      │
                      │ HTTP GET /metrics
                      │
              ┌───────▼────────┐
              │   Prometheus   │
              │  (scrape)      │
              └────────────────┘
```

## Instalacja Node Exporter na Ubuntu 24.04

### Metoda 1: Instalacja manualna

```bash
# Pobierz najnowszą wersję Node Exporter
wget https://github.com/prometheus/node_exporter/releases/download/v1.7.0/node_exporter-1.7.0.linux-amd64.tar.gz

# Rozpakuj archiwum
tar xvfz node_exporter-1.7.0.linux-amd64.tar.gz

# Skopiuj plik binarny do katalogu systemowego
sudo cp node_exporter-1.7.0.linux-amd64/node_exporter /usr/local/bin/

# Nadaj uprawnienia wykonywania
sudo chmod +x /usr/local/bin/node_exporter

# Usuń pobrane pliki
rm -rf node_exporter-1.7.0.linux-amd64*
```

### Metoda 2: Instalacja przez package manager (apt)

```bash
# Aktualizuj listę pakietów
sudo apt update

# Zainstaluj prometheus-node-exporter
sudo apt install prometheus-node-exporter -y

# Sprawdź status
sudo systemctl status prometheus-node-exporter
```

**Uwaga:** Instalacja przez apt automatycznie konfiguruje usługę systemd.

## Konfiguracja usługi systemd

Utwórz plik usługi systemd:

```bash
sudo nano /etc/systemd/system/node_exporter.service
```

Dodaj następującą konfigurację:

```ini
[Unit]
Description=Node Exporter
Documentation=https://github.com/prometheus/node_exporter
Wants=network-online.target
After=network-online.target

[Service]
User=prometheus
Group=prometheus
Type=simple
Restart=on-failure
ExecStart=/usr/local/bin/node_exporter \
  --collector.filesystem.mount-points-exclude='^/(sys|proc|dev|host|etc)($$|/)' \
  --collector.netdev.device-exclude='^(veth.*|br.*|docker.*|virbr.*|lo)$' \
  --web.listen-address=:9100

[Install]
WantedBy=multi-user.target
```

**Wyjaśnienie parametrów usługi:**

- **User/Group=prometheus**: Uruchom jako użytkownik prometheus (bezpieczeństwo)
- **Type=simple**: Prosty typ usługi
- **Restart=on-failure**: Automatyczny restart w przypadku awarii
- **ExecStart**: Komenda uruchamiająca Node Exporter z parametrami

**Wyjaśnienie parametrów Node Exporter:**

- **--collector.filesystem.mount-points-exclude**: Wyklucza wirtualne systemy plików (proc, sys, dev) z monitorowania
- **--collector.netdev.device-exclude**: Wyklucza wirtualne interfejsy sieciowe (docker, bridge, loopback)
- **--web.listen-address**: Port na którym Node Exporter nasłuchuje (domyślnie 9100)

### Utworzenie użytkownika systemowego

```bash
# Utwórz użytkownika prometheus (jeśli nie istnieje)
sudo useradd --no-create-home --shell /bin/false prometheus
```

**Wyjaśnienie:**
- **--no-create-home**: Nie twórz katalogu domowego
- **--shell /bin/false**: Użytkownik nie może się zalogować interaktywnie (bezpieczeństwo)

## Uruchomienie Node Exporter

```bash
# Przeładuj konfigurację systemd
sudo systemctl daemon-reload

# Uruchom Node Exporter
sudo systemctl start node_exporter

# Włącz automatyczne uruchamianie przy starcie systemu
sudo systemctl enable node_exporter

# Sprawdź status usługi
sudo systemctl status node_exporter
```

Poprawny output powinien wyglądać tak:

```
● node_exporter.service - Node Exporter
     Loaded: loaded (/etc/systemd/system/node_exporter.service; enabled)
     Active: active (running) since Mon 2026-02-03 10:00:00 UTC
```

## Weryfikacja działania

### Sprawdzenie dostępności metryk

```bash
# Sprawdź czy Node Exporter odpowiada
curl http://localhost:9100/metrics
```

Powinieneś zobaczyć output z metrykami:

```
# HELP node_cpu_seconds_total Seconds the CPUs spent in each mode.
# TYPE node_cpu_seconds_total counter
node_cpu_seconds_total{cpu="0",mode="idle"} 1234567.89
node_cpu_seconds_total{cpu="0",mode="system"} 12345.67
...
```

### Filtrowanie konkretnych metryk

```bash
# Metryki pamięci RAM
curl -s http://localhost:9100/metrics | grep node_memory

# Metryki CPU
curl -s http://localhost:9100/metrics | grep node_cpu

# Metryki dysków
curl -s http://localhost:9100/metrics | grep node_filesystem
```

### Sprawdzenie portów

```bash
# Sprawdź czy port 9100 jest otwarty
sudo netstat -tulpn | grep 9100

# Lub używając ss
sudo ss -tulpn | grep 9100
```

Oczekiwany output:

```
tcp6       0      0 :::9100                 :::*                    LISTEN      12345/node_exporter
```

## Konfiguracja Prometheusa do zbierania metryk

Dodaj Node Exporter jako target w pliku `/etc/prometheus/prometheus.yml`:

```yaml
scrape_configs:
  # Monitorowanie lokalnego Node Exporter
  - job_name: 'node_exporter'
    scrape_interval: 15s
    static_configs:
      - targets: ['localhost:9100']
        labels:
          hostname: 'ubuntu-server-01'
          environment: 'production'
```

Po zapisaniu zrestartuj Prometheusa:

```bash
sudo systemctl restart prometheus
```

## Collectors - moduły zbierające metryki

Node Exporter składa się z wielu collectorów (modułów), które zbierają różne typy metryk. Domyślnie większość z nich jest włączona.

### Najważniejsze collectors:

#### 1. **CPU Collector**
Zbiera metryki CPU:
- `node_cpu_seconds_total` – czas spędzony w różnych trybach (user, system, idle, iowait)

#### 2. **Memory Collector**
Zbiera metryki pamięci:
- `node_memory_MemTotal_bytes` – całkowita pamięć RAM
- `node_memory_MemFree_bytes` – wolna pamięć
- `node_memory_MemAvailable_bytes` – dostępna pamięć
- `node_memory_Cached_bytes` – pamięć cache
- `node_memory_Buffers_bytes` – bufory

#### 3. **Filesystem Collector**
Zbiera metryki systemów plików:
- `node_filesystem_size_bytes` – rozmiar partycji
- `node_filesystem_free_bytes` – wolne miejsce
- `node_filesystem_avail_bytes` – dostępne miejsce
- `node_filesystem_files` – liczba i-nodów

#### 4. **Disk Collector**
Zbiera metryki operacji dyskowych:
- `node_disk_reads_completed_total` – liczba odczytów
- `node_disk_writes_completed_total` – liczba zapisów
- `node_disk_read_bytes_total` – bajty odczytane
- `node_disk_written_bytes_total` – bajty zapisane
- `node_disk_io_time_seconds_total` – czas spędzony na I/O

#### 5. **Network Collector**
Zbiera metryki sieciowe:
- `node_network_receive_bytes_total` – bajty odebrane
- `node_network_transmit_bytes_total` – bajty wysłane
- `node_network_receive_errs_total` – błędy odbioru
- `node_network_transmit_errs_total` – błędy transmisji

#### 6. **Load Average Collector**
Zbiera średnie obciążenie systemu:
- `node_load1` – średnie obciążenie z 1 minuty
- `node_load5` – średnie obciążenie z 5 minut
- `node_load15` – średnie obciążenie z 15 minut

### Włączanie/wyłączanie collectorów

```bash
# Uruchom tylko wybrane collectors
/usr/local/bin/node_exporter \
  --collector.cpu \
  --collector.meminfo \
  --collector.filesystem \
  --collector.diskstats \
  --no-collector.netdev

# Wyłącz konkretny collector
/usr/local/bin/node_exporter --no-collector.hwmon
```

### Lista dostępnych collectorów

```bash
# Sprawdź wszystkie dostępne collectors
node_exporter --help | grep collector
```

## Zaawansowana konfiguracja

### Bezpieczeństwo - Basic Auth

Możesz zabezpieczyć Node Exporter hasłem:

1. Zainstaluj apache2-utils:

```bash
sudo apt install apache2-utils
```

2. Wygeneruj hasło:

```bash
htpasswd -nBC 10 "" | tr -d ':\n'
```

3. Utwórz plik konfiguracyjny `/etc/node_exporter/config.yml`:

```yaml
basic_auth_users:
  prometheus: $2y$10$hashedpassword...
```

4. Uruchom Node Exporter z konfiguracją:

```bash
/usr/local/bin/node_exporter --web.config.file=/etc/node_exporter/config.yml
```

### TLS/HTTPS

Konfiguracja HTTPS dla Node Exporter:

```yaml
# /etc/node_exporter/config.yml
tls_server_config:
  cert_file: /etc/node_exporter/certs/cert.pem
  key_file: /etc/node_exporter/certs/key.pem
```

### Custom Textfile Collector

Node Exporter może zbierać metryki z plików tekstowych:

```bash
# Włącz textfile collector z katalogiem
/usr/local/bin/node_exporter \
  --collector.textfile.directory=/var/lib/node_exporter/textfile_collector
```

Utwórz plik z metrykami:

```bash
# Utwórz katalog
sudo mkdir -p /var/lib/node_exporter/textfile_collector

# Dodaj własne metryki
echo 'custom_metric{label="test"} 123' | sudo tee /var/lib/node_exporter/textfile_collector/custom.prom
```

## Przykładowe zapytania PromQL

### Wykorzystanie pamięci RAM (%)

```PromQL
100 * (1 - (node_memory_MemAvailable_bytes / node_memory_MemTotal_bytes))
```

### Średnie wykorzystanie CPU

```PromQL
100 - (avg by (instance) (rate(node_cpu_seconds_total{mode="idle"}[5m])) * 100)
```

### Wolne miejsce na dysku (GB)

```PromQL
node_filesystem_avail_bytes{fstype=~"ext4|xfs"} / 1024 / 1024 / 1024
```

### Transfer sieciowy (MB/s)

```PromQL
rate(node_network_receive_bytes_total{device!~"lo|veth.*"}[5m]) / 1024 / 1024
```

## Rozwiązywanie problemów

### Problem: Node Exporter nie uruchamia się

```bash
# Sprawdź logi systemd
sudo journalctl -u node_exporter -f

# Sprawdź czy binary istnieje
ls -la /usr/local/bin/node_exporter

# Sprawdź uprawnienia
sudo chmod +x /usr/local/bin/node_exporter
```

### Problem: Port 9100 jest zajęty

```bash
# Sprawdź co zajmuje port
sudo lsof -i :9100

# Uruchom na innym porcie
/usr/local/bin/node_exporter --web.listen-address=:9101
```

### Problem: Brak dostępu do metryk

```bash
# Sprawdź firewall
sudo ufw status
sudo ufw allow 9100/tcp

# Test połączenia
telnet localhost 9100
```

### Problem: Prometheus nie widzi targetu

```bash
# Sprawdź czy Node Exporter działa
curl http://localhost:9100/metrics

# Sprawdź konfigurację Prometheusa
promtool check config /etc/prometheus/prometheus.yml

# Sprawdź status targetów w Prometheus UI
# http://prometheus:9090/targets
```

## Monitorowanie wielu serwerów

Aby monitorować wiele serwerów, zainstaluj Node Exporter na każdym z nich i dodaj do Prometheusa:

```yaml
scrape_configs:
  - job_name: 'node_exporters'
    static_configs:
      - targets:
          - 'server1:9100'
          - 'server2:9100'
          - 'server3:9100'
        labels:
          datacenter: 'dc1'
          environment: 'production'
```

## Dashboard w Grafanie

Najlepsze gotowe dashboardy dla Node Exporter:

1. **Node Exporter Full** (ID: 1860)
   - Kompletny dashboard ze wszystkimi metrykami
   - Import: Dashboards > Import > 1860

2. **Node Exporter Quick** (ID: 13978)
   - Uproszczona wersja z najważniejszymi metrykami

3. **Node Exporter Server Metrics** (ID: 11074)
   - Dedykowany dla serwerów produkcyjnych

## Najlepsze praktyki

### 1. **Bezpieczeństwo**
- Używaj Basic Auth lub TLS dla produkcji
- Ogranicz dostęp przez firewall tylko do IP Prometheusa
- Uruchamiaj jako dedykowany użytkownik (nie root)

### 2. **Wydajność**
- Wyłącz niepotrzebne collectors aby zmniejszyć overhead
- Dostosuj scrape_interval w zależności od potrzeb (15-60s)
- Używaj relabeling w Prometheusie do filtrowania metryk

### 3. **Monitorowanie**
- Monitoruj sam Node Exporter (up, scrape_duration)
- Ustaw alerty na kluczowe metryki (CPU, RAM, Disk)
- Regularnie aktualizuj do najnowszych wersji

### 4. **Organizacja**
- Używaj sensownych etykiet (hostname, environment, role)
- Grupuj serwery według funkcji w job_name
- Dokumentuj niestandardowe collectors

## Przydatne komendy

```bash
# Restart usługi
sudo systemctl restart node_exporter

# Sprawdź logi w czasie rzeczywistym
sudo journalctl -u node_exporter -f

# Wyświetl wersję
node_exporter --version

# Lista wszystkich metryk
curl -s http://localhost:9100/metrics | grep "# HELP"

# Liczba dostępnych metryk
curl -s http://localhost:9100/metrics | grep -c "# HELP"

# Backup konfiguracji
sudo cp /etc/systemd/system/node_exporter.service /etc/systemd/system/node_exporter.service.backup
```

## Podsumowanie

Node Exporter to niezbędne narzędzie do monitorowania systemów Linux w ekosystemie Prometheusa. Kluczowe cechy:

- **Łatwa instalacja i konfiguracja** – gotowy do użycia w kilka minut
- **Bogate metryki** – szczegółowe informacje o CPU, RAM, dyskach, sieci
- **Modularność** – możliwość dostosowania do potrzeb
- **Integracja** – natywne wsparcie dla Prometheusa i Grafany
- **Stabilność** – sprawdzony w produkcji przez tysiące organizacji

Po poprawnej konfiguracji Node Exporter będzie automatycznie zbierał metryki systemowe, które Prometheus może przechowywać i analizować, a Grafana wizualizować w formie przejrzystych dashboardów.
