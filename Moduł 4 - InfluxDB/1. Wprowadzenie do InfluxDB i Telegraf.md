# Czym jest InfluxDB?

**InfluxDB** to specjalistyczna baza danych szeregów czasowych (Time Series Database - TSDB) zaprojektowana do przechowywania i analizowania danych, które zmieniają się w czasie. Jest to open-source'owy projekt stworzony przez firmę InfluxData.

### Kluczowe cechy InfluxDB

- **Optymalizacja pod kątem szeregów czasowych** - dane są zawsze przechowywane z informacją o czasie ich powstania
- **Wysoka wydajność zapisu** - obsługa milionów punktów danych na sekundę
- **Efektywna kompresja** - automatyczne kompresowanie starych danych
- **Wbudowany język zapytań** - Flux (InfluxDB 2.x) lub InfluxQL (InfluxDB 1.x)
- **Retencja danych** - automatyczne usuwanie starych danych według polityk
- **Downsampling** - agregacja danych w czasie (np. zmiana z sekundowych na minutowe)

### Do czego służy InfluxDB?

InfluxDB znajduje zastosowanie wszędzie tam, gdzie potrzebujemy:

1. **Monitoring infrastruktury IT**
   - Metryki CPU, RAM, dysku, sieci
   - Logi systemowe z timestamp
   - Wydajność aplikacji
   - Uptime serwisów

2. **IoT (Internet of Things)**
   - Dane z czujników temperatury, wilgotności
   - Monitoring urządzeń przemysłowych
   - Smart home - dane z czujników ruchu, oświetlenia
   - Lokalizacja GPS w czasie rzeczywistym

3. **Analityka biznesowa**
   - Metryki sprzedażowe w czasie
   - Analiza ruchu na stronie WWW
   - Monitoring transakcji
   - KPI (Key Performance Indicators)

4. **Monitoring aplikacji**
   - Response time API
   - Liczba requestów na sekundę
   - Błędy i wyjątki
   - Wykorzystanie zasobów przez aplikację

### Model danych InfluxDB

InfluxDB organizuje dane w specyficzny sposób:

```
measurement,tag1=value1,tag2=value2 field1=value1,field2=value2 timestamp
```

**Przykład:**
```
cpu,host=server01,region=eu-west usage_idle=85.2,usage_user=10.5,usage_system=4.3 1644854400000000000
```

Gdzie:
- **Measurement** (`cpu`) - nazwa tabeli/kolekcji, określa co mierzymy
- **Tags** (`host=server01`, `region=eu-west`) - indeksowane metadane, używane do filtrowania
- **Fields** (`usage_idle=85.2`) - rzeczywiste wartości metryk (nie indeksowane)
- **Timestamp** - czas w nanosekunkach (Unix epoch)

**Dlaczego taki model?**
- **Tags** są indeksowane - szybkie wyszukiwanie i grupowanie
- **Fields** przechowują wartości - mogą być różnych typów (float, integer, string, boolean)
- **Timestamp** jest automatycznie dodawany, jeśli go nie podamy

---

## Czym jest Telegraf?

**Telegraf** to agent do zbierania metryk (metrics collection agent) stworzony również przez InfluxData. Jest to lekki demon działający w tle, który:

- Zbiera metryki z różnych źródeł
- Przetwarza i formatuje dane
- Wysyła dane do baz danych (głównie InfluxDB)

### Architektura Telegraf

```
┌─────────────┐      ┌──────────────┐      ┌─────────────┐
│   Inputs    │─────▶│  Processors  │─────▶│  Outputs    │
│  (Plugins)  │      │  (Opcjonalne)│      │  (Plugins)  │
└─────────────┘      └──────────────┘      └─────────────┘
     │                                            │
     │                                            │
  Zbieranie                                   Wysyłanie
  metryk z:                                   danych do:
  - systemu                                   - InfluxDB
  - aplikacji                                 - Prometheus
  - baz danych                                - Grafana Cloud
  - API                                       - Kafka
  - plików log                                - ElasticSearch
```

### Rola Telegraf w ekosystemie monitoringu

**Telegraf pełni kluczową rolę jako:**

1. **Uniwersalny kolektor danych**
   - Jeden agent do zbierania wszystkich metryk
   - Ponad 300 wtyczek wejściowych (input plugins)
   - Ponad 50 wtyczek wyjściowych (output plugins)

2. **Most między źródłami a bazą danych**
   - Normalizacja formatu danych
   - Przekształcanie danych "w locie"
   - Filtrowanie niepotrzebnych metryk

3. **Lekki agent z małym naddatkiem**
   - Niskie zużycie CPU i RAM
   - Możliwość uruchomienia na słabszych urządzeniach
   - Brak zależności - pojedynczy plik binarny

### Najważniejsze rodzaje wtyczek Telegraf

#### Input Plugins (źródła danych):

- **system** - metryki CPU, RAM, dysku
- **docker** - metryki kontenerów Docker
- **nginx** - statystyki serwera Nginx
- **postgresql/mysql** - metryki baz danych
- **prometheus** - zbieranie z endpointów Prometheus
- **snmp** - monitoring urządzeń sieciowych
- **http_response** - monitoring dostępności HTTP

#### Output Plugins (cele):

- **influxdb_v2** - wysyłanie do InfluxDB 2.x
- **prometheus_client** - eksport dla Prometheus
- **file** - zapis do pliku (debugging)
- **kafka** - wysyłanie do Apache Kafka

---

## Podstawowa konfiguracja Telegraf

### Struktura pliku konfiguracyjnego

Telegraf używa formatu TOML dla swojej konfiguracji. Domyślna lokalizacja:
```
/etc/telegraf/telegraf.conf
```

### Minimalna konfiguracja

```toml
# Globalne ustawienia agenta
[agent]
  interval = "10s"              # Częstotliwość zbierania metryk
  round_interval = true         # Zaokrąglenie do pełnych 10s
  metric_batch_size = 1000      # Maksymalna liczba metryk w jednej partii
  metric_buffer_limit = 10000   # Bufor dla metryk
  collection_jitter = "0s"      # Losowe opóźnienie zbierania
  flush_interval = "10s"        # Częstotliwość wysyłania do bazy
  flush_jitter = "0s"           # Losowe opóźnienie wysyłania

# Output do InfluxDB 2.x
[[outputs.influxdb_v2]]
  urls = ["http://localhost:8086"]
  token = "twój-token-tutaj"
  organization = "twoja-organizacja"
  bucket = "telegraf"

# Input - metryki CPU
[[inputs.cpu]]
  percpu = true                 # Metryki dla każdego CPU osobno
  totalcpu = true               # Również suma dla wszystkich CPU
  collect_cpu_time = false      # Nie zbieraj czasu CPU
  report_active = false         # Nie raportuj aktywnego czasu

# Input - metryki pamięci RAM
[[inputs.mem]]
  # Zbiera: total, available, used, free, cached, buffered

# Input - metryki dysku
[[inputs.disk]]
  ignore_fs = ["tmpfs", "devtmpfs", "devfs", "iso9660", "overlay", "aufs", "squashfs"]

# Input - I/O dysku
[[inputs.diskio]]
  # Zbiera: reads, writes, IOPS, czas oczekiwania

# Input - metryki sieci
[[inputs.net]]
  # Zbiera: bytes in/out, packets in/out, errors
```

### Wyjaśnienie kluczowych parametrów

#### Sekcja [agent]

- **interval** - jak często Telegraf zbiera metryki (tutaj: co 10 sekund)
- **flush_interval** - jak często wysyła dane do InfluxDB (tutaj: co 10 sekund)
- **metric_batch_size** - ile metryk maksymalnie w jednej paczce
- **metric_buffer_limit** - ile metryk może być w buforze (zapas na wypadek problemu z wysyłką)

#### Sekcja [[outputs.influxdb_v2]]

- **urls** - adres serwera InfluxDB (może być wiele)
- **token** - token uwierzytelniający (generujemy w InfluxDB)
- **organization** - nazwa organizacji w InfluxDB
- **bucket** - nazwa bucketu (odpowiednik bazy danych)

### Generowanie tokenu w InfluxDB

1. Zaloguj się do interfejsu InfluxDB (http://localhost:8086)
2. Przejdź do **Data** → **API Tokens**
3. Kliknij **Generate API Token**
4. Wybierz **All Access Token** lub **Custom API Token**
5. Skopiuj token - **nie będziesz go mógł ponownie wyświetlić!**

### Konfiguracja z tagami globalnymi

Możesz dodać tagi, które będą dołączane do wszystkich metryk:

```toml
[global_tags]
  environment = "production"
  datacenter = "eu-west-1"
  host = "monitoring-server-01"
```

Dzięki temu w InfluxDB każda metryka będzie miała dodatkowo te tagi, co ułatwi filtrowanie.

### Testowanie konfiguracji

Przed uruchomieniem warto przetestować składnię:

```bash
# Test składni konfiguracji
telegraf --config /etc/telegraf/telegraf.conf --test

# Test z pełnym outputem (bez wysyłania do bazy)
telegraf --config /etc/telegraf/telegraf.conf --test --input-filter cpu --output-filter file
```

### Przykład rozszerzonej konfiguracji

```toml
[agent]
  interval = "10s"
  round_interval = true
  flush_interval = "10s"

[global_tags]
  environment = "production"

[[outputs.influxdb_v2]]
  urls = ["http://localhost:8086"]
  token = "$INFLUX_TOKEN"  # Można użyć zmiennej środowiskowej
  organization = "szkolen ia"
  bucket = "system_metrics"
  timeout = "5s"
  # Retry przy błędzie połączenia
  influx_uint_support = true

[[inputs.cpu]]
  percpu = true
  totalcpu = true

[[inputs.mem]]

[[inputs.disk]]
  ignore_fs = ["tmpfs", "devtmpfs"]

[[inputs.diskio]]

[[inputs.system]]
  # Metryki: load1, load5, load15, n_users, n_cpus, uptime

[[inputs.net]]
  interfaces = ["eth*", "enp*"]  # Tylko interfejsy ethernet

[[inputs.netstat]]
  # Statystyki połączeń sieciowych

[[inputs.processes]]
  # Liczba procesów w różnych stanach

[[inputs.docker]]
  endpoint = "unix:///var/run/docker.sock"
  container_names = []  # Puste = wszystkie kontenery
  timeout = "5s"
  perdevice = false
  total = true
```

---

## Schemat działania InfluxDB + Telegraf

```
┌──────────────────────────────────────────────────────────────┐
│                        SERWER                                │
│                                                              │
│  ┌──────────────┐         ┌─────────────────┐                │
│  │   Telegraf   │────────▶│    InfluxDB     │                │
│  │   (Agent)    │  HTTP   │  (Baza danych)  │                │
│  │              │  :8086  │                 │                │
│  └──────────────┘         └─────────────────┘                │
│         │                          │                         │
│         │ Zbiera metryki           │ Przechowuje             │
│         │ z systemu                │ szeregi czasowe         │
│  ┌─────────────────────────────────────────┐                 │
│  │  CPU, RAM, Dysk, Sieć, Docker, etc.     │                 │
│  └─────────────────────────────────────────┘                 │
│                                                              │
└──────────────────────────────────────────────────────────────┘
                            │
                            │ HTTP API :3000
                            ▼
                ┌───────────────────────┐
                │       Grafana         │
                │  (Wizualizacja)       │
                └───────────────────────┘
```

### Przepływ danych:

1. **Telegraf** zbiera metryki z systemu co N sekund (default: 10s)
2. **Telegraf** formatuje dane do formatu InfluxDB Line Protocol
3. **Telegraf** wysyła dane HTTP POST do InfluxDB (port 8086)
4. **InfluxDB** przechowuje dane w bucketach z polityką retencji
5. **Grafana** odpytuje InfluxDB przez API i tworzy wykresy

---

## Porównanie z innymi rozwiązaniami

### InfluxDB vs Prometheus

| Cecha | InfluxDB | Prometheus |
|-------|----------|------------|
| Model zbierania | **Push** (agent wysyła) | **Pull** (centralny scraping) |
| Język zapytań | Flux / InfluxQL | PromQL |
| Retencja danych | Wbudowana | Zewnętrzne narzędzia |
| Skalowanie | Cluster (Enterprise) | Federation |
| Kompresja | Bardzo dobra | Dobra |

### Kiedy wybrać InfluxDB?

- Potrzebujesz **push model** (agenty wysyłają dane)
- Masz **rozproszone źródła** danych (IoT, edge devices)
- Chcesz **natywną retencję** i downsampling
- Potrzebujesz **wielu źródeł** danych (nie tylko metryki)
- 
---

## Podsumowanie

**InfluxDB** to specjalistyczna baza danych do szeregów czasowych, idealna do:
- Monitoringu infrastruktury IT
- Zbierania danych IoT
- Przechowywania metryk aplikacji
- Analityki biznesowej w czasie

**Telegraf** to uniwersalny agent zbierający metryki, który:
- Działa jako most między źródłami danych a bazą
- Oferuje setki gotowych wtyczek
- Jest lekki i wydajny
- Integruje się natywnie z InfluxDB

**Razem tworzą potężny stack monitoringowy:**
```
Telegraf (zbieranie) → InfluxDB (przechowywanie) → Grafana (wizualizacja)
```

W kolejnych materiałach pokażemy:
- Jak zainstalować InfluxDB i Telegraf
- Jak skonfigurować zaawansowane input plugins
- Jak tworzyć zapytania w języku Flux
- Jak integrować z Grafaną
- Jak optymalizować wydajność
