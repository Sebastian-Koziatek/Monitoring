# Instalacja i konfiguracja InfluxDB i Telegraf

## Wprowadzenie

Ten dokument przeprowadzi Cię przez proces instalacji i konfiguracji **InfluxDB v2** oraz **Telegraf** na systemie Ubuntu 24.04 LTS. InfluxDB to baza danych szeregów czasowych, a Telegraf to agent zbierający metryki systemowe.

**Czego się nauczysz:**
- Jak zainstalować InfluxDB v2 na Ubuntu 24.04
- Jak skonfigurować Telegraf do zbierania metryk systemowych
- Jak zintegrować InfluxDB z Grafaną
- Jak tworzyć zapytania w języku Flux
- Jak rozwiązywać typowe problemy z instalacją

**Wymagania:**
- Ubuntu 24.04 LTS
- Uprawnienia sudo
- Dostęp do internetu
- Grafana zainstalowana (opcjonalnie)

---

## Część 1: Instalacja InfluxDB

### Krok 1: Dodanie repozytorium InfluxDB

Pierwszym krokiem jest dodanie oficjalnego repozytorium InfluxData oraz pobranie klucza GPG niezbędnego do weryfikacji pakietów.

```bash
# Instalacja wymaganych pakietów
sudo apt update
sudo apt install -y wget gnupg2 curl apt-transport-https

# Dodanie klucza GPG InfluxDB (metoda 1 - preferowana)
curl -fsSL https://repos.influxdata.com/influxdata-archive_compat.key | gpg --dearmor | sudo tee /etc/apt/keyrings/influxdata-archive-keyring.gpg > /dev/null

# Dodanie repozytorium InfluxDB z odpowiednim kluczem
echo "deb [signed-by=/etc/apt/keyrings/influxdata-archive-keyring.gpg] https://repos.influxdata.com/debian stable main" | sudo tee /etc/apt/sources.list.d/influxdata.list > /dev/null

# Aktualizacja listy pakietów
sudo apt update
```

**Wyjaśnienie:**
- `/etc/apt/keyrings/` - katalog na klucze GPG (standard od Ubuntu 22.04)
- `signed-by=` - określa, który klucz ma być użyty do weryfikacji podpisów pakietów
- `curl -fsSL` - bezpieczne pobranie klucza z oficjalnego serwera InfluxData

**Alternatywna metoda (jeśli powyższa nie działa):**

```bash
# Metoda 2 - bezpośrednie pobranie klucza
wget -qO- https://repos.influxdata.com/influxdata-archive_compat.key | sudo apt-key add -

# Dodanie repozytorium
echo "deb https://repos.influxdata.com/ubuntu $(lsb_release -cs) stable" | sudo tee /etc/apt/sources.list.d/influxdata.list

# Aktualizacja
sudo apt update
```

**Uwaga:** Jeśli nadal występują problemy z kluczem GPG, użyj poniższej komendy:

```bash
# Import klucza bezpośrednio
sudo gpg --keyserver keyserver.ubuntu.com --recv-keys DA61C26A0585BD3B
sudo gpg --export DA61C26A0585BD3B | sudo tee /etc/apt/trusted.gpg.d/influxdb.gpg > /dev/null
```

### Krok 2: Instalacja pakietu InfluxDB

```bash
# Aktualizacja listy pakietów
sudo apt update

# Instalacja InfluxDB
sudo apt install -y influxdb2

# Uruchomienie i włączenie usługi
sudo systemctl start influxdb
sudo systemctl enable influxdb

# Sprawdzenie statusu
sudo systemctl status influxdb
```

**Oczekiwany rezultat:**
```
● influxdb.service - InfluxDB is an open-source, distributed, time series database
     Loaded: loaded (/lib/systemd/system/influxdb.service; enabled; vendor preset: enabled)
     Active: active (running)
```

**Co się dzieje w tle:**
- InfluxDB uruchamia się na porcie `8086`
- Pliki konfiguracyjne znajdują się w `/etc/influxdb/`
- Dane są przechowywane w `/var/lib/influxdb/`
- Logi są dostępne przez `journalctl -u influxdb`

### Krok 3: Konfiguracja początkowa InfluxDB

InfluxDB v2 wymaga konfiguracji przez interfejs webowy lub CLI. Ta konfiguracja tworzy:
- Początkowego użytkownika (administratora)
- Organizację (Organization) - logiczny kontener dla bucketów i użytkowników
- Bucket - miejsce przechowywania danych szeregów czasowych
- Token autoryzacyjny - klucz API do dostępu

#### Opcja A: Konfiguracja przez interfejs webowy

1. Otwórz przeglądarkę i wejdź na: `http://localhost:8086`
2. Wypełnij formularz początkowej konfiguracji:
   - **Username**: `admin`
   - **Password**: `secure_password_123` (użyj silnego hasła!)
   - **Organization Name**: `grafana_org`
   - **Bucket Name**: `grafana_bucket`
3. Kliknij **Continue**
4. Skopiuj wygenerowany **API Token** (będzie potrzebny później)

#### Opcja B: Konfiguracja przez CLI

```bash
# Konfiguracja początkowa
influx setup \
  --username admin \
  --password secure_password_123 \
  --org grafana_org \
  --bucket grafana_bucket \
  --retention 0 \
  --force

# Wyświetlenie tokena
influx auth list
```

**Ważne:** Zapisz wygenerowany token w bezpiecznym miejscu! Token jest jak hasło do API.

**Wyjaśnienie parametrów:**
- `--username` - nazwa użytkownika administratora
- `--password` - hasło (minimum 8 znaków)
- `--org` - nazwa organizacji
- `--bucket` - nazwa bucketu (kontenera danych)
- `--retention 0` - dane przechowywane bez limitu czasowego (0 = infinite)
- `--force` - nadpisanie istniejącej konfiguracji

### Krok 4: Tworzenie dodatkowego tokena (opcjonalne)

Możesz utworzyć tokeny z ograniczonymi uprawnieniami dla różnych aplikacji:

```bash
# Utworzenie tokena z ograniczonymi uprawnieniami
influx auth create \
  --org grafana_org \
  --read-buckets \
  --write-buckets \
  --description "Telegraf write token"
```

Skopiuj wygenerowany token - będzie potrzebny w konfiguracji Telegrafa.

**Rodzaje uprawnień:**
- `--read-buckets` - odczyt danych z bucketów
- `--write-buckets` - zapis danych do bucketów
- `--read-dashboards` - odczyt dashboardów
- `--all-access` - pełne uprawnienia (równoważne tokenowi administratora)

---

## Część 2: Instalacja Telegraf

Telegraf to agent zbierający metryki systemowe i wysyłający je do InfluxDB. Jest to tzw. "push-based" system monitoringu.

### Krok 5: Instalacja pakietu Telegraf

```bash
# Telegraf jest w tym samym repozytorium co InfluxDB
sudo apt install -y telegraf

# Sprawdzenie wersji
telegraf --version

# Uruchomienie i włączenie usługi
sudo systemctl start telegraf
sudo systemctl enable telegraf
```

