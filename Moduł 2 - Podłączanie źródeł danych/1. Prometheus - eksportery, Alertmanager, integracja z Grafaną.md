## Prometheus w ekosystemie Grafany – rola, funkcje, integracja

![Prometheus w ekosystemie Grafany](../grafiki/004-prometheus.png)

Prometheus to otwartoźródłowy system monitorowania i zbierania metryk, zaprojektowany z myślą o środowiskach dynamicznych, takich jak konteneryzacja i chmura. W architekturze obserwowalności opartej o Grafanę pełni funkcję głównego źródła metryk czasowych (time series), które następnie są wizualizowane, korelowane i analizowane w Grafanie.

### Kluczowe funkcje Prometheusa

- **Zbieranie metryk**: Prometheus okresowo pobiera (scrape) metryki z endpointów HTTP/HTTPS eksporterów oraz aplikacji instrumentowanych. Każda próbka metryki opatrzona jest zestawem labeli, co umożliwia precyzyjne filtrowanie i agregację danych.
- **Przechowywanie danych**: Dane przechowywane są lokalnie w TSDB (Time Series Database) z kontrolą retencji i wydajności. Możliwa jest replikacja i zdalny storage (np. Thanos, Cortex) dla środowisk produkcyjnych o wysokiej dostępności.
- **Query (PromQL)**: Prometheus udostępnia własny język zapytań PromQL, pozwalający na zaawansowaną analizę, agregację i korelację metryk.
- **Alerting**: System reguł alertowych umożliwia definiowanie warunków powiadomień, które są przekazywane do Alertmanagera.
- **Eksportery**: Komponenty pośredniczące, udostępniające metryki z systemów, baz danych, aplikacji (np. node_exporter, mysqld_exporter).

### Rola Prometheusa w połączeniu z Grafaną

![Integracja Prometheus-Grafana](../grafiki/005-prometheus-grafana-integration.png)

1. **Źródło danych (datasource)**: Grafana integruje się z Prometheusem poprzez natywny plugin datasource, wykorzystując API HTTP Prometheusa. Pozwala to na bezpośrednie wykonywanie zapytań PromQL z poziomu paneli dashboardów.
2. **Wizualizacja i korelacja**: Metryki z Prometheusa mogą być prezentowane w różnych formach (wykresy, statystyki, heatmapy), a także korelowane z innymi źródłami danych (np. logi z Lokiego, klasyczny monitoring z Zabbixa).
3. **Alerting zintegrowany**: Grafana może pobierać i prezentować stan reguł alertowych Prometheusa, a także umożliwiać zarządzanie powiadomieniami (w nowszych wersjach – własny silnik alertowy Grafany).
4. **Provisioning i automatyzacja**: W środowiskach produkcyjnych rekomendowane jest automatyczne provisionowanie datasource Prometheus w Grafanie (pliki YAML), co zapewnia spójność i powtarzalność konfiguracji.

### Typowe decyzje projektowe i dobre praktyki

- **Label hygiene**: Należy unikać nadmiarowych i dynamicznych labeli, które mogą prowadzić do eksplozji cardinality i problemów z wydajnością TSDB.
- **Retencja i storage**: Określenie polityki retencji danych w Prometheusie (np. 15–30 dni lokalnie, dłużej w zdalnym storage) zgodnie z wymaganiami biznesowymi i kosztami storage.
- **Bezpieczeństwo**: Ograniczenie dostępu do API Prometheusa (autoryzacja, sieć), segmentacja środowisk (dev/test/prod) poprzez osobne instancje lub labelowanie.
- **Standaryzacja nazw jobów i metryk**: Spójne nazewnictwo ułatwia zarządzanie dashboardami i regułami alertów w Grafanie.

### Typowe błędy produkcyjne

- Brak kontroli cardinality (np. dynamiczne labele z hostname, user_id)
- Zbyt długa retencja na lokalnym storage bez zdalnej replikacji
- Brak automatyzacji provisioning datasource w Grafanie
- Niespójność nazw jobów/metryk utrudniająca korelację i alertowanie

### Wymagania środowiskowe (lab)

- Prometheus (najlepiej w kontenerze lub VM, port 9090)
- Eksporter (np. node_exporter, port 9100)
- Grafana (port 3000)
- Połączenie sieciowe pomiędzy komponentami

### Rezultaty integracji

- Uczestnik potrafi skonfigurować Prometheusa jako datasource w Grafanie
- Umie tworzyć dashboardy oparte o zapytania PromQL
- Rozumie architekturę przepływu metryk i zależności między komponentami
- Potrafi zdiagnozować typowe problemy z integracją i wydajnością

---

## Szczegółowa instrukcja instalacji Prometheusa

### Instalacja z repozytorium

> **Uwaga:** Instalacja z repozytorium automatycznie tworzy użytkownika systemowego `prometheus` oraz wszystkie niezbędne katalogi. NIE twórz ich ręcznie przed instalacją.

#### 1. Aktualizacja systemu i instalacja zależności

Aktualizuj system:

```bash
sudo apt update && sudo apt upgrade -y
```

Zainstaluj niezbędne narzędzia:

```bash
sudo apt install -y wget curl
```

#### 2. Dodaj repozytorium Prometheus

Pobierz klucz GPG dla repozytorium:

```bash
wget -q -O - https://apt.grafana.com/gpg.key | sudo apt-key add -
```

Dodaj repozytorium:

```bash
echo "deb https://apt.grafana.com stable main" | sudo tee /etc/apt/sources.list.d/grafana.list
```

Zaktualizuj listę pakietów:

```bash
sudo apt update
```

#### 3. Zainstaluj Prometheus

Zainstaluj prometheus i prometheus-node-exporter:

```bash
sudo apt install -y prometheus prometheus-node-exporter
```

**Uwaga:** Instalacja automatycznie utworzy użytkownika systemowego `prometheus` oraz katalogi `/etc/prometheus` i `/var/lib/prometheus`.

#### 4. Konfiguracja podstawowa

Edytuj plik `/etc/prometheus/prometheus.yml`:

```bash
sudo nano /etc/prometheus/prometheus.yml
```

Zawartość pliku:

```yaml
# Globalna konfiguracja
global:
  scrape_interval: 15s
  evaluation_interval: 15s

# Konfiguracja jobów scrapowania metryk
scrape_configs:
  # Job monitorujący samego Prometheusa
  - job_name: 'prometheus'
    static_configs:
      - targets: ['localhost:9090']

  # Job dla node_exporter
  - job_name: 'node_exporter'
    static_configs:
      - targets: ['localhost:9100']
```

#### 5. Uruchom i włącz usługi

Uruchom Prometheus:

```bash
sudo systemctl start prometheus
```

Włącz automatyczne uruchamianie przy starcie systemu:

```bash
sudo systemctl enable prometheus
```

Sprawdź status usługi:

```bash
sudo systemctl status prometheus
```

Uruchom Node Exporter:

```bash
sudo systemctl start prometheus-node-exporter
sudo systemctl enable prometheus-node-exporter
```

---

### Weryfikacja instalacji i pierwsze kroki

#### 1. Sprawdź Web UI

Otwórz przeglądarkę i przejdź do `http://localhost:9090` (lub adresu IP serwera).

#### 2. Wykonaj testowe zapytanie PromQL

W zakładce **Graph** wprowadź zapytanie:

```promql
# Sprawdź stan targetsów
up

# Liczba aktywnych targetsów
count(up == 1)

# Wykorzystanie CPU (wymaga node_exporter)
100 - (avg by(instance) (irate(node_cpu_seconds_total{mode="idle"}[5m])) * 100)
```

#### 3. Sprawdź targets

Przejdź do **Status → Targets** i upewnij się, że target `prometheus` ma status **UP**.

#### 4. Sprawdź metryki

Za pomocą curl:

```bash
curl http://localhost:9090/api/v1/query?query=up
```

Sprawdź wszystkie dostępne metryki:

```bash
curl http://localhost:9090/api/v1/label/__name__/values
```

#### 5. Przetestuj reload konfiguracji (jeśli włączone --web.enable-lifecycle)

Po zmianie prometheus.yml:

```bash
curl -X POST http://localhost:9090/-/reload
```

Lub restart usługi:

```bash
sudo systemctl restart prometheus
```

---

### Weryfikacja i testowanie node_exporter

Node Exporter został już zainstalowany wraz z Prometheus z repozytorium.

#### Sprawdź status usługi

Sprawdź czy node_exporter działa:

```bash
sudo systemctl status prometheus-node-exporter
```

#### Przetestuj metryki

Sprawdź czy node_exporter zwraca metryki:

```bash
curl http://localhost:9100/metrics
```

#### Sprawdź w Prometheus Web UI

1. Otwórz przeglądarkę: `http://localhost:9090`
2. Przejdź do **Status → Targets**
3. Sprawdź czy target `node_exporter` ma status **UP**

#### Przykładowe zapytania PromQL dla node_exporter

```promql
# Wykorzystanie CPU
100 - (avg by(instance) (irate(node_cpu_seconds_total{mode="idle"}[5m])) * 100)

# Wykorzystanie pamięci
100 * (1 - (node_memory_MemAvailable_bytes / node_memory_MemTotal_bytes))

# Wolne miejsce na dysku
100 * (1 - (node_filesystem_avail_bytes / node_filesystem_size_bytes))

# Load average
node_load1
node_load5
node_load15
```

---

### Najczęstsze problemy i ich rozwiązania

#### 0. Błąd podczas instalacji: "User prometheus already exists"

Jeśli podczas instalacji pojawił się błąd:
```
fatal: The user `prometheus' already exists, but is not a system user. Exiting.
```

**Rozwiązanie:**

Usuń ręcznie utworzonego użytkownika i przeinstaluj pakiet:

```bash
sudo userdel prometheus
```

Usuń częściowo zainstalowane pakiety:

```bash
sudo apt remove --purge prometheus prometheus-node-exporter prometheus-node-exporter-collectors
```

Usuń katalogi (jeśli były tworzone ręcznie):

```bash
sudo rm -rf /etc/prometheus
sudo rm -rf /var/lib/prometheus
```

Ponownie zainstaluj pakiety:

```bash
sudo apt install -y prometheus prometheus-node-exporter
```

Sprawdź uprawnienia do katalogów:

```bash
sudo chown -R prometheus:prometheus /etc/prometheus
sudo chown -R prometheus:prometheus /var/lib/prometheus
```

#### 1. Prometheus nie startuje

```bash
# Sprawdź logi
sudo journalctl -u prometheus -n 50 --no-pager

# Sprawdź składnię pliku konfiguracyjnego
promtool check config /etc/prometheus/prometheus.yml

# Sprawdź uprawnienia
ls -la /etc/prometheus/
ls -la /var/lib/prometheus/
```

#### 2. Target pokazuje status DOWN

- Sprawdź czy usługa działa: `sudo systemctl status node_exporter`
- Sprawdź firewall: `sudo ufw status` lub `sudo firewall-cmd --list-all`
- Sprawdź połączenie: `curl http://localhost:9100/metrics`
- Sprawdź logi Prometheusa: `sudo journalctl -u prometheus -f`

#### 3. Problemy z uprawnieniami

```bash
# Upewnij się że katalogi należą do użytkownika prometheus
sudo chown -R prometheus:prometheus /etc/prometheus
sudo chown -R prometheus:prometheus /var/lib/prometheus
```

#### 4. Brak miejsca na dysku

```bash
# Sprawdź wykorzystanie
df -h /var/lib/prometheus

# Skróć retencję w usłudze systemd (edytuj ExecStart)
--storage.tsdb.retention.time=7d

# Lub wyczyść stare dane
sudo systemctl stop prometheus
sudo rm -rf /var/lib/prometheus/*
sudo systemctl start prometheus
```

#### 5. Port 9090 zajęty

```bash
# Sprawdź co używa portu
sudo lsof -i :9090
sudo netstat -tulpn | grep 9090

# Zmień port w ExecStart
--web.listen-address=0.0.0.0:9091
```

---

## Dodatkowe instalacje

### Instalacja Prometheusa w Docker

#### Podstawowe uruchomienie kontenera

```bash
# Uruchom Prometheusa w kontenerze
docker run -d \
  --name prometheus \
  -p 9090:9090 \
  -v /path/to/prometheus.yml:/etc/prometheus/prometheus.yml \
  prom/prometheus:latest
```

#### Docker Compose (rekomendowane)

Utwórz plik `docker-compose.yml`:

```yaml
version: '3.8'

services:
  prometheus:
    image: prom/prometheus:latest
    container_name: prometheus
    restart: unless-stopped
    ports:
      - "9090:9090"
    volumes:
      - ./prometheus.yml:/etc/prometheus/prometheus.yml
      - ./rules:/etc/prometheus/rules
      - prometheus-data:/prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--storage.tsdb.retention.time=15d'
      - '--web.console.libraries=/usr/share/prometheus/console_libraries'
      - '--web.console.templates=/usr/share/prometheus/consoles'
      - '--web.enable-lifecycle'
    networks:
      - monitoring

  node-exporter:
    image: prom/node-exporter:latest
    container_name: node-exporter
    restart: unless-stopped
    ports:
      - "9100:9100"
    command:
      - '--path.procfs=/host/proc'
      - '--path.sysfs=/host/sys'
      - '--path.rootfs=/rootfs'
      - '--collector.filesystem.mount-points-exclude=^/(sys|proc|dev|host|etc)($$|/)'
    volumes:
      - /proc:/host/proc:ro
      - /sys:/host/sys:ro
      - /:/rootfs:ro
    networks:
      - monitoring

volumes:
  prometheus-data:

networks:
  monitoring:
    driver: bridge
```

Plik `prometheus.yml` dla Docker Compose:

```yaml
global:
  scrape_interval: 15s
  evaluation_interval: 15s

scrape_configs:
  - job_name: 'prometheus'
    static_configs:
      - targets: ['localhost:9090']

  - job_name: 'node-exporter'
    static_configs:
      - targets: ['node-exporter:9100']
```

Uruchomienie:

```bash
# Uruchom całą stack
docker-compose up -d

# Sprawdź status
docker-compose ps

# Sprawdź logi
docker-compose logs -f prometheus

# Zatrzymaj
docker-compose down

# Zatrzymaj i usuń wolumeny
docker-compose down -v
```

---

### Instalacja node_exporter w Docker

```bash
docker run -d \
  --name node-exporter \
  --net="host" \
  --pid="host" \
  -v "/:/host:ro,rslave" \
  prom/node-exporter:latest \
  --path.rootfs=/host
```

---

### Instalacja w Kubernetes (Helm)

#### Instalacja za pomocą Helm Chart

```bash
# Dodaj repozytorium Prometheus Community
helm repo add prometheus-community https://prometheus-community.github.io/helm-charts
helm repo update

# Zainstaluj Prometheus Stack (rekomendowane - zawiera Grafanę)
helm install prometheus prometheus-community/kube-prometheus-stack \
  --namespace monitoring \
  --create-namespace

# Lub tylko Prometheus
helm install prometheus prometheus-community/prometheus \
  --namespace monitoring \
  --create-namespace

# Sprawdź status
kubectl get pods -n monitoring

# Port-forward do Web UI
kubectl port-forward -n monitoring svc/prometheus-kube-prometheus-prometheus 9090:9090

# Otwórz w przeglądarce: http://localhost:9090
```

#### Dostosowanie konfiguracji

Utwórz plik `values.yaml`:

```yaml
prometheus:
  prometheusSpec:
    retention: 15d
    storageSpec:
      volumeClaimTemplate:
        spec:
          accessModes: ["ReadWriteOnce"]
          resources:
            requests:
              storage: 50Gi
    resources:
      requests:
        cpu: 500m
        memory: 2Gi
      limits:
        cpu: 2000m
        memory: 4Gi
```

Zainstaluj z custom values:

```bash
helm install prometheus prometheus-community/kube-prometheus-stack \
  -f values.yaml \
  --namespace monitoring \
  --create-namespace
```

---

### Następne kroki

Po pomyślnej instalacji Prometheusa:

1. **Zainstaluj eksportery** dla monitorowanych systemów (node_exporter, mysqld_exporter, etc.)
2. **Skonfiguruj Grafanę** jako datasource (zobacz następne moduły)
3. **Utwórz pierwsze dashboardy** w Grafanie
4. **Skonfiguruj Alertmanager** dla powiadomień
5. **Zdefiniuj reguły alertowe** w Prometheusie
6. **Zabezpiecz instalację** (TLS, basic auth, reverse proxy)

### Przydatne zasoby

- Oficjalna dokumentacja: https://prometheus.io/docs/
- Lista eksporterów: https://prometheus.io/docs/instrumenting/exporters/
- PromQL guide: https://prometheus.io/docs/prometheus/latest/querying/basics/
- Best practices: https://prometheus.io/docs/practices/naming/
