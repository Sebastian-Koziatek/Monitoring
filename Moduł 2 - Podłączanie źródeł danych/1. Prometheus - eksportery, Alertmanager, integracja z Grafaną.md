## Prometheus w ekosystemie Grafany – rola, funkcje, integracja

![Prometheus w ekosystemie Grafany](../grafiki/004-prometheus.png)

Prometheus to otwartoźródłowy system monitorowania i zbierania metryk, zaprojektowany z myślą o środowiskach dynamicznych, takich jak konteneryzacja i chmura. W architekturze obserwowalności opartej o Grafanę pełni funkcję głównego źródła metryk czasowych (time series), które następnie są wizualizowane, korelowane i analizowane w Grafanie.

### Kluczowe funkcje Prometheusa

- **Zbieranie metryk**: Prometheus okresowo pobiera (scrape) metryki z endpointów HTTP/HTTPS eksporterów oraz aplikacji instrumentowanych. Każda próbka metryki opatrzona jest zestawem labeli, co umożliwia precyzyjne filtrowanie i agregację danych.
- **Przechowywanie danych**: Dane przechowywane są lokalnie w TSDB (Time Series Database) z kontrolą retencji i wydajności. Możliwa jest replikacja i zdalny storage (np. Thanos, Cortex) dla środowisk produkcyjnych o wysokiej dostępności.
- **Query (PromQL)**: Prometheus udostępnia własny język zapytań PromQL, pozwalający na zaawansowaną analizę, agregację i korelację metryk.
- **Alerting**: System reguł alertowych umożliwia definiowanie warunków powiadomień, które są przekazywane do Alertmanagera.
- **Eksportery**: Komponenty pośredniczące, udostępniające metryki z systemów, baz danych, aplikacji (np. node_exporter, mysqld_exporter).

### Rola Prometheusa w połączeniu z Grafaną

![Integracja Prometheus-Grafana](../grafiki/005-prometheus-grafana-integration.png)

1. **Źródło danych (datasource)**: Grafana integruje się z Prometheusem poprzez natywny plugin datasource, wykorzystując API HTTP Prometheusa. Pozwala to na bezpośrednie wykonywanie zapytań PromQL z poziomu paneli dashboardów.
2. **Wizualizacja i korelacja**: Metryki z Prometheusa mogą być prezentowane w różnych formach (wykresy, statystyki, heatmapy), a także korelowane z innymi źródłami danych (np. logi z Lokiego, klasyczny monitoring z Zabbixa).
3. **Alerting zintegrowany**: Grafana może pobierać i prezentować stan reguł alertowych Prometheusa, a także umożliwiać zarządzanie powiadomieniami (w nowszych wersjach – własny silnik alertowy Grafany).
4. **Provisioning i automatyzacja**: W środowiskach produkcyjnych rekomendowane jest automatyczne provisionowanie datasource Prometheus w Grafanie (pliki YAML), co zapewnia spójność i powtarzalność konfiguracji.

### Typowe decyzje projektowe i dobre praktyki

- **Label hygiene**: Należy unikać nadmiarowych i dynamicznych labeli, które mogą prowadzić do eksplozji cardinality i problemów z wydajnością TSDB.
- **Retencja i storage**: Określenie polityki retencji danych w Prometheusie (np. 15–30 dni lokalnie, dłużej w zdalnym storage) zgodnie z wymaganiami biznesowymi i kosztami storage.
- **Bezpieczeństwo**: Ograniczenie dostępu do API Prometheusa (autoryzacja, sieć), segmentacja środowisk (dev/test/prod) poprzez osobne instancje lub labelowanie.
- **Standaryzacja nazw jobów i metryk**: Spójne nazewnictwo ułatwia zarządzanie dashboardami i regułami alertów w Grafanie.

### Typowe błędy produkcyjne

- Brak kontroli cardinality (np. dynamiczne labele z hostname, user_id)
- Zbyt długa retencja na lokalnym storage bez zdalnej replikacji
- Brak automatyzacji provisioning datasource w Grafanie
- Niespójność nazw jobów/metryk utrudniająca korelację i alertowanie

### Wymagania środowiskowe (lab)

- Prometheus (najlepiej w kontenerze lub VM, port 9090)
- Eksporter (np. node_exporter, port 9100)
- Grafana (port 3000)
- Połączenie sieciowe pomiędzy komponentami

### Rezultaty integracji

- Uczestnik potrafi skonfigurować Prometheusa jako datasource w Grafanie
- Umie tworzyć dashboardy oparte o zapytania PromQL
- Rozumie architekturę przepływu metryk i zależności między komponentami
- Potrafi zdiagnozować typowe problemy z integracją i wydajnością

---

## Szczegółowa instrukcja instalacji Prometheusa

### Metoda 1: Instalacja z binarnych plików (Linux/macOS)

#### 1.1 Pobranie najnowszej wersji

```bash
# Sprawdź najnowszą wersję na: https://prometheus.io/download/
# Dla Linux (amd64):
cd /tmp
wget https://github.com/prometheus/prometheus/releases/download/v2.50.1/prometheus-2.50.1.linux-amd64.tar.gz

# Dla macOS (arm64 - M1/M2):
wget https://github.com/prometheus/prometheus/releases/download/v2.50.1/prometheus-2.50.1.darwin-arm64.tar.gz

# Dla macOS (amd64 - Intel):
wget https://github.com/prometheus/prometheus/releases/download/v2.50.1/prometheus-2.50.1.darwin-amd64.tar.gz
```

#### 1.2 Rozpakowanie i instalacja

```bash
# Rozpakuj archiwum
tar xvfz prometheus-*.tar.gz
cd prometheus-*

# Skopiuj pliki binarne do /usr/local/bin (wymaga sudo)
sudo cp prometheus /usr/local/bin/
sudo cp promtool /usr/local/bin/

# Utwórz katalogi konfiguracyjne
sudo mkdir -p /etc/prometheus
sudo mkdir -p /var/lib/prometheus

# Skopiuj pliki konfiguracyjne
sudo cp prometheus.yml /etc/prometheus/
sudo cp -r consoles /etc/prometheus/
sudo cp -r console_libraries /etc/prometheus/

# Utwórz użytkownika systemowego dla Prometheusa
sudo useradd --no-create-home --shell /bin/false prometheus

# Ustaw odpowiednie uprawnienia
sudo chown -R prometheus:prometheus /etc/prometheus
sudo chown -R prometheus:prometheus /var/lib/prometheus
sudo chown prometheus:prometheus /usr/local/bin/prometheus
sudo chown prometheus:prometheus /usr/local/bin/promtool
```

#### 1.3 Konfiguracja podstawowa

Edytuj plik `/etc/prometheus/prometheus.yml`:

```yaml
# Globalna konfiguracja
global:
  scrape_interval: 15s # Częstotliwość zbierania metryk (domyślnie 15s)
  evaluation_interval: 15s # Częstotliwość ewaluacji reguł
  external_labels:
    cluster: 'production'
    region: 'eu-central-1'

# Konfiguracja Alertmanagera (opcjonalnie)
alerting:
  alertmanagers:
    - static_configs:
        - targets:
          # - 'localhost:9093'

# Pliki z regułami alertowymi
rule_files:
  # - "rules/*.yml"

# Konfiguracja jobów scrapowania metryk
scrape_configs:
  # Job monitorujący samego Prometheusa
  - job_name: 'prometheus'
    static_configs:
      - targets: ['localhost:9090']

  # Job dla node_exporter (do dodania po instalacji eksportera)
  # - job_name: 'node_exporter'
  #   static_configs:
  #     - targets: ['localhost:9100']
  #       labels:
  #         instance: 'server-01'
```

#### 1.4 Utworzenie usługi systemd (Linux)

Utwórz plik `/etc/systemd/system/prometheus.service`:

```ini
[Unit]
Description=Prometheus Monitoring System
Documentation=https://prometheus.io/docs/introduction/overview/
After=network-online.target
Wants=network-online.target

[Service]
User=prometheus
Group=prometheus
Type=simple
ExecStart=/usr/local/bin/prometheus \
  --config.file=/etc/prometheus/prometheus.yml \
  --storage.tsdb.path=/var/lib/prometheus/ \
  --storage.tsdb.retention.time=15d \
  --web.console.templates=/etc/prometheus/consoles \
  --web.console.libraries=/etc/prometheus/console_libraries \
  --web.listen-address=0.0.0.0:9090 \
  --web.enable-lifecycle

Restart=always
RestartSec=10s

[Install]
WantedBy=multi-user.target
```

#### 1.5 Uruchomienie Prometheusa

```bash
# Przeładuj konfigurację systemd
sudo systemctl daemon-reload

# Włącz automatyczne uruchamianie przy starcie systemu
sudo systemctl enable prometheus

# Uruchom usługę
sudo systemctl start prometheus

# Sprawdź status
sudo systemctl status prometheus

# Sprawdź logi
sudo journalctl -u prometheus -f
```

#### 1.6 Weryfikacja instalacji

```bash
# Sprawdź czy Prometheus odpowiada
curl http://localhost:9090/-/healthy

# Sprawdź metryki
curl http://localhost:9090/metrics

# Otwórz Web UI w przeglądarce
# http://localhost:9090
```

---

### Metoda 2: Instalacja za pomocą Docker

#### 2.1 Podstawowe uruchomienie kontenera

```bash
# Uruchom Prometheusa w kontenerze
docker run -d \
  --name prometheus \
  -p 9090:9090 \
  -v /path/to/prometheus.yml:/etc/prometheus/prometheus.yml \
  prom/prometheus:latest
```

#### 2.2 Docker Compose (rekomendowane)

Utwórz plik `docker-compose.yml`:

```yaml
version: '3.8'

services:
  prometheus:
    image: prom/prometheus:latest
    container_name: prometheus
    restart: unless-stopped
    ports:
      - "9090:9090"
    volumes:
      - ./prometheus.yml:/etc/prometheus/prometheus.yml
      - ./rules:/etc/prometheus/rules
      - prometheus-data:/prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--storage.tsdb.retention.time=15d'
      - '--web.console.libraries=/usr/share/prometheus/console_libraries'
      - '--web.console.templates=/usr/share/prometheus/consoles'
      - '--web.enable-lifecycle'
    networks:
      - monitoring

  node-exporter:
    image: prom/node-exporter:latest
    container_name: node-exporter
    restart: unless-stopped
    ports:
      - "9100:9100"
    command:
      - '--path.procfs=/host/proc'
      - '--path.sysfs=/host/sys'
      - '--path.rootfs=/rootfs'
      - '--collector.filesystem.mount-points-exclude=^/(sys|proc|dev|host|etc)($$|/)'
    volumes:
      - /proc:/host/proc:ro
      - /sys:/host/sys:ro
      - /:/rootfs:ro
    networks:
      - monitoring

volumes:
  prometheus-data:

networks:
  monitoring:
    driver: bridge
```

Plik `prometheus.yml` dla Docker Compose:

```yaml
global:
  scrape_interval: 15s
  evaluation_interval: 15s

scrape_configs:
  - job_name: 'prometheus'
    static_configs:
      - targets: ['localhost:9090']

  - job_name: 'node-exporter'
    static_configs:
      - targets: ['node-exporter:9100']
```

Uruchomienie:

```bash
# Uruchom całą stack
docker-compose up -d

# Sprawdź status
docker-compose ps

# Sprawdź logi
docker-compose logs -f prometheus

# Zatrzymaj
docker-compose down

# Zatrzymaj i usuń wolumeny
docker-compose down -v
```

---

### Metoda 3: Instalacja za pomocą menedżera pakietów

#### 3.1 Ubuntu/Debian (APT)

```bash
# Dodaj użytkownika prometheus
sudo useradd --no-create-home --shell /bin/false prometheus

# Pobierz i zainstaluj pakiet
wget https://github.com/prometheus/prometheus/releases/download/v2.50.1/prometheus-2.50.1.linux-amd64.tar.gz
tar xvf prometheus-2.50.1.linux-amd64.tar.gz
cd prometheus-2.50.1.linux-amd64

# Skopiuj binaria
sudo cp prometheus promtool /usr/local/bin/
sudo chown prometheus:prometheus /usr/local/bin/prometheus
sudo chown prometheus:prometheus /usr/local/bin/promtool

# Skopiuj konfigurację
sudo mkdir -p /etc/prometheus /var/lib/prometheus
sudo cp -r consoles console_libraries prometheus.yml /etc/prometheus
sudo chown -R prometheus:prometheus /etc/prometheus /var/lib/prometheus
```

---

### Metoda 3: Instalacja w Kubernetes (Helm)

#### 4.1 Instalacja za pomocą Helm Chart

```bash
# Dodaj repozytorium Prometheus Community
helm repo add prometheus-community https://prometheus-community.github.io/helm-charts
helm repo update

# Zainstaluj Prometheus Stack (rekomendowane - zawiera Grafanę)
helm install prometheus prometheus-community/kube-prometheus-stack \
  --namespace monitoring \
  --create-namespace

# Lub tylko Prometheus
helm install prometheus prometheus-community/prometheus \
  --namespace monitoring \
  --create-namespace

# Sprawdź status
kubectl get pods -n monitoring

# Port-forward do Web UI
kubectl port-forward -n monitoring svc/prometheus-kube-prometheus-prometheus 9090:9090

# Otwórz w przeglądarce: http://localhost:9090
```

#### 4.2 Dostosowanie konfiguracji

Utwórz plik `values.yaml`:

```yaml
prometheus:
  prometheusSpec:
    retention: 15d
    storageSpec:
      volumeClaimTemplate:
        spec:
          accessModes: ["ReadWriteOnce"]
          resources:
            requests:
              storage: 50Gi
    resources:
      requests:
        cpu: 500m
        memory: 2Gi
      limits:
        cpu: 2000m
        memory: 4Gi
```

Zainstaluj z custom values:

```bash
helm install prometheus prometheus-community/kube-prometheus-stack \
  -f values.yaml \
  --namespace monitoring \
  --create-namespace
```

---

### Weryfikacja instalacji i pierwsze kroki

#### 1. Sprawdź Web UI

Otwórz przeglądarkę i przejdź do `http://localhost:9090` (lub adresu IP serwera).

#### 2. Wykonaj testowe zapytanie PromQL

W zakładce **Graph** wprowadź zapytanie:

```promql
# Sprawdź stan targetsów
up

# Liczba aktywnych targetsów
count(up == 1)

# Wykorzystanie CPU (wymaga node_exporter)
100 - (avg by(instance) (irate(node_cpu_seconds_total{mode="idle"}[5m])) * 100)
```

#### 3. Sprawdź targets

Przejdź do **Status → Targets** i upewnij się, że target `prometheus` ma status **UP**.

#### 4. Sprawdź metryki

```bash
# Za pomocą curl
curl http://localhost:9090/api/v1/query?query=up

# Sprawdź wszystkie dostępne metryki
curl http://localhost:9090/api/v1/label/__name__/values
```

#### 5. Przetestuj reload konfiguracji (jeśli włączone --web.enable-lifecycle)

```bash
# Po zmianie prometheus.yml
curl -X POST http://localhost:9090/-/reload

# Lub restart usługi
sudo systemctl restart prometheus
```

---

### Instalacja node_exporter (eksporter metryk systemowych)

#### Metoda 1: Binarnie (Linux)

```bash
# Pobierz node_exporter
cd /tmp
wget https://github.com/prometheus/node_exporter/releases/download/v1.7.0/node_exporter-1.7.0.linux-amd64.tar.gz
tar xvfz node_exporter-*.tar.gz
cd node_exporter-*

# Skopiuj binarny plik
sudo cp node_exporter /usr/local/bin/
sudo chown prometheus:prometheus /usr/local/bin/node_exporter

# Utwórz usługę systemd
sudo tee /etc/systemd/system/node_exporter.service > /dev/null <<EOF
[Unit]
Description=Node Exporter
After=network.target

[Service]
User=prometheus
Group=prometheus
Type=simple
ExecStart=/usr/local/bin/node_exporter

[Install]
WantedBy=multi-user.target
EOF

# Uruchom usługę
sudo systemctl daemon-reload
sudo systemctl enable node_exporter
sudo systemctl start node_exporter
sudo systemctl status node_exporter
```

#### Metoda 2: Docker

```bash
docker run -d \
  --name node-exporter \
  --net="host" \
  --pid="host" \
  -v "/:/host:ro,rslave" \
  prom/node-exporter:latest \
  --path.rootfs=/host
```

#### Dodanie node_exporter do Prometheusa

Edytuj `/etc/prometheus/prometheus.yml`:

```yaml
scrape_configs:
  - job_name: 'prometheus'
    static_configs:
      - targets: ['localhost:9090']

  - job_name: 'node_exporter'
    static_configs:
      - targets: ['localhost:9100']
        labels:
          instance: 'server-01'
          environment: 'production'
```

Przeładuj konfigurację:

```bash
# Jeśli włączone --web.enable-lifecycle
curl -X POST http://localhost:9090/-/reload

# Lub restart
sudo systemctl restart prometheus
```

Sprawdź target w Web UI: **Status → Targets**

---

### Najczęstsze problemy i ich rozwiązania

#### 1. Prometheus nie startuje

```bash
# Sprawdź logi
sudo journalctl -u prometheus -n 50 --no-pager

# Sprawdź składnię pliku konfiguracyjnego
promtool check config /etc/prometheus/prometheus.yml

# Sprawdź uprawnienia
ls -la /etc/prometheus/
ls -la /var/lib/prometheus/
```

#### 2. Target pokazuje status DOWN

- Sprawdź czy usługa działa: `sudo systemctl status node_exporter`
- Sprawdź firewall: `sudo ufw status` lub `sudo firewall-cmd --list-all`
- Sprawdź połączenie: `curl http://localhost:9100/metrics`
- Sprawdź logi Prometheusa: `sudo journalctl -u prometheus -f`

#### 3. Problemy z uprawnieniami

```bash
# Upewnij się że katalogi należą do użytkownika prometheus
sudo chown -R prometheus:prometheus /etc/prometheus
sudo chown -R prometheus:prometheus /var/lib/prometheus
```

#### 4. Brak miejsca na dysku

```bash
# Sprawdź wykorzystanie
df -h /var/lib/prometheus

# Skróć retencję w usłudze systemd (edytuj ExecStart)
--storage.tsdb.retention.time=7d

# Lub wyczyść stare dane
sudo systemctl stop prometheus
sudo rm -rf /var/lib/prometheus/*
sudo systemctl start prometheus
```

#### 5. Port 9090 zajęty

```bash
# Sprawdź co używa portu
sudo lsof -i :9090
sudo netstat -tulpn | grep 9090

# Zmień port w ExecStart
--web.listen-address=0.0.0.0:9091
```

---

### Następne kroki

Po pomyślnej instalacji Prometheusa:

1. **Zainstaluj eksportery** dla monitorowanych systemów (node_exporter, mysqld_exporter, etc.)
2. **Skonfiguruj Grafanę** jako datasource (zobacz następne moduły)
3. **Utwórz pierwsze dashboardy** w Grafanie
4. **Skonfiguruj Alertmanager** dla powiadomień
5. **Zdefiniuj reguły alertowe** w Prometheusie
6. **Zabezpiecz instalację** (TLS, basic auth, reverse proxy)

### Przydatne zasoby

- Oficjalna dokumentacja: https://prometheus.io/docs/
- Lista eksporterów: https://prometheus.io/docs/instrumenting/exporters/
- PromQL guide: https://prometheus.io/docs/prometheus/latest/querying/basics/
- Best practices: https://prometheus.io/docs/practices/naming/
