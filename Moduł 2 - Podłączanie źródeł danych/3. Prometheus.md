## Prometheus w ekosystemie Grafany – rola, funkcje, integracja

![Prometheus w ekosystemie Grafany](../grafiki/004-prometheus.png)

Prometheus to otwartoźródłowy system monitorowania i zbierania metryk, zaprojektowany z myślą o środowiskach dynamicznych, takich jak konteneryzacja i chmura. W architekturze obserwowalności opartej o Grafanę pełni funkcję głównego źródła metryk czasowych (time series), które następnie są wizualizowane, korelowane i analizowane w Grafanie.

### Kluczowe funkcje Prometheusa

- **Zbieranie metryk**: Prometheus okresowo pobiera (scrape) metryki z endpointów HTTP/HTTPS eksporterów oraz aplikacji instrumentowanych. Każda próbka metryki opatrzona jest zestawem labeli, co umożliwia precyzyjne filtrowanie i agregację danych.
- **Przechowywanie danych**: Dane przechowywane są lokalnie w TSDB (Time Series Database) z kontrolą retencji i wydajności. Możliwa jest replikacja i zdalny storage (np. Thanos, Cortex) dla środowisk produkcyjnych o wysokiej dostępności.
- **Query (PromQL)**: Prometheus udostępnia własny język zapytań PromQL, pozwalający na zaawansowaną analizę, agregację i korelację metryk.
- **Alerting**: System reguł alertowych umożliwia definiowanie warunków powiadomień, które są przekazywane do Alertmanagera.
- **Eksportery**: Komponenty pośredniczące, udostępniające metryki z systemów, baz danych, aplikacji (np. node_exporter, mysqld_exporter).

### Rola Prometheusa w połączeniu z Grafaną

![Integracja Prometheus-Grafana](../grafiki/005-prometheus-grafana-integration.png)

1. **Źródło danych (datasource)**: Grafana integruje się z Prometheusem poprzez natywny plugin datasource, wykorzystując API HTTP Prometheusa. Pozwala to na bezpośrednie wykonywanie zapytań PromQL z poziomu paneli dashboardów.
2. **Wizualizacja i korelacja**: Metryki z Prometheusa mogą być prezentowane w różnych formach (wykresy, statystyki, heatmapy), a także korelowane z innymi źródłami danych (np. logi z Lokiego, klasyczny monitoring z Zabbixa).
3. **Alerting zintegrowany**: Grafana może pobierać i prezentować stan reguł alertowych Prometheusa, a także umożliwiać zarządzanie powiadomieniami (w nowszych wersjach – własny silnik alertowy Grafany).
4. **Provisioning i automatyzacja**: W środowiskach produkcyjnych rekomendowane jest automatyczne provisionowanie datasource Prometheus w Grafanie (pliki YAML), co zapewnia spójność i powtarzalność konfiguracji.

### Typowe decyzje projektowe i dobre praktyki

- **Label hygiene**: Należy unikać nadmiarowych i dynamicznych labeli, które mogą prowadzić do eksplozji cardinality i problemów z wydajnością TSDB.
- **Retencja i storage**: Określenie polityki retencji danych w Prometheusie (np. 15–30 dni lokalnie, dłużej w zdalnym storage) zgodnie z wymaganiami biznesowymi i kosztami storage.
- **Bezpieczeństwo**: Ograniczenie dostępu do API Prometheusa (autoryzacja, sieć), segmentacja środowisk (dev/test/prod) poprzez osobne instancje lub labelowanie.
- **Standaryzacja nazw jobów i metryk**: Spójne nazewnictwo ułatwia zarządzanie dashboardami i regułami alertów w Grafanie.

### Typowe błędy produkcyjne

- Brak kontroli cardinality (np. dynamiczne labele z hostname, user_id)
- Zbyt długa retencja na lokalnym storage bez zdalnej replikacji
- Brak automatyzacji provisioning datasource w Grafanie
- Niespójność nazw jobów/metryk utrudniająca korelację i alertowanie
