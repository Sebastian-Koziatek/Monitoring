## Zabbix w ekosystemie Grafany – rola, funkcje, integracja

### Czym jest Zabbix?

Zabbix to dojrzałe, otwartoźródłowe rozwiązanie monitoringu infrastruktury IT, działające w modelu server-agent. Powstało w 1998 roku i od tego czasu ewoluowało w kompleksową platformę do monitorowania sieci, serwerów, aplikacji, usług oraz zasobów wirtualnych i chmurowych. Zabbix oferuje zbieranie metryk, wykrywanie problemów (triggers), alertowanie, wizualizację oraz raportowanie w jednym, zintegrowanym środowisku.

**Kluczowe cechy Zabbix:**

- **Model server-agent**: Zabbix Server zbiera dane z Zabbix Agents zainstalowanych na monitorowanych hostach
- **Agentless monitoring**: SNMP, IPMI, JMX, HTTP checks – możliwość monitorowania bez instalacji agenta
- **Active vs Passive checks**: Active (agent inicjuje połączenie) vs Passive (server odpytuje agenta)
- **Templates**: Reużywalne szablony konfiguracji dla różnych typów hostów (Linux, Windows, DBMS, hardware)
- **Triggers**: System reguł definiujących warunki problemów (expressions based on collected metrics)
- **Auto-discovery**: Automatyczne wykrywanie hostów, sieci, interfejsów, filesystems
- **Alerting**: Wielopoziomowy system powiadomień (escalations) z różnymi kanałami (email, SMS, webhooks, scripts)
- **Web UI**: Graficzny interfejs administracyjny do konfiguracji, wizualizacji i zarządzania
- **API**: RESTful JSON-RPC API dla automatyzacji i integracji

Zabbix jest szczególnie popularny w środowiskach korporacyjnych i datacenter, gdzie wymaga się centralnego monitoringu heterogenicznych środowisk z tysiącami hostów.

### Rola Zabbix w połączeniu z Grafaną

Zabbix oferuje własny system wizualizacji (dashboardy, graphs, screens), jednak Grafana jest często wybierana jako warstwa prezentacji ze względu na:
- bardziej nowoczesny i responsywny UI,
- łatwiejszą customizację dashboardów,
- możliwość korelacji danych z wielu źródeł (Zabbix + Prometheus + InfluxDB + Loki) w jednym dashboardzie,
- lepszą kontrolę nad layoutem i estetyką wizualizacji.

**Zastosowania w kontekście Grafany:**

1. **Unified observability dashboard**: Grafana jako single pane of glass dla danych z Zabbix (klasyczny monitoring) oraz nowoczesnych platform (Prometheus, Loki)
2. **Legacy migration strategy**: Stopniowa migracja z Zabbix wizualizacji do Grafany, utrzymując Zabbix jako backend zbierania metryk i alertowania
3. **Executive dashboards**: Tworzenie high-level KPI dashboards w Grafanie z danymi z Zabbix (SLA, uptime, capacity planning)
4. **Multi-tenant visualization**: Grafana Organizations/Teams dla różnych zespołów korzystających z tego samego Zabbix Server

**Typowy przepływ danych:**

```
Hosty (Zabbix Agent) → Zabbix Server → Zabbix Database (MySQL/PostgreSQL) → Grafana → Dashboardy
Sieci (SNMP) ↗                       ↓
                                 Zabbix Web UI (równoległa wizualizacja/konfiguracja)
```

**Różnice względem Prometheus/InfluxDB:**

- **Model push vs pull**: Zabbix (agent aktywny lub pasywny) vs Prometheus (scraping)
- **Scope**: Zabbix = all-in-one (monitoring + alerting + visualization), Prometheus = focused on metrics collection
- **Configuration**: Zabbix (web UI + XML templates + database-driven), Prometheus (YAML files, code-driven)
- **Ecosystem maturity**: Zabbix starszy i bardziej monolityczny, Prometheus modularny i cloud-native

### Jak wygląda połączenie z Grafaną

#### Konfiguracja datasource w Grafanie

Grafana integruje się z Zabbix poprzez dedykowany plugin datasource. Istnieją dwie główne opcje:

1. **Oficjalny Zabbix plugin (Alexander Zobnin)**: Najpopularniejszy community plugin
2. **Grafana Enterprise Zabbix datasource**: Oficjalny plugin w wersji Enterprise (od Grafana 8.x)

**Instalacja community plugin:**

```bash
grafana-cli plugins install alexanderzobnin-zabbix-app
# lub Docker:
docker run -e "GF_INSTALL_PLUGINS=alexanderzobnin-zabbix-app" grafana/grafana
```

#### Parametry połączenia

1. **Dodanie źródła danych:**
   - W Grafanie: Configuration → Data Sources → Add data source → Zabbix

2. **Parametry konfiguracyjne:**
   - **URL**: Adres Zabbix API (np. `http://zabbix-server/zabbix/api_jsonrpc.php`)
   - **Username/Password**: Credentials użytkownika Zabbix z odpowiednimi uprawnieniami (minimum read)
   - **Trends**: Wykorzystanie Zabbix trends dla optymalizacji zapytań historycznych (agregacja danych)
   - **Cache TTL**: Time-to-live dla cache'owanych danych (zmniejsza obciążenie Zabbix Server)
   - **Direct DB Connection** (opcjonalne, wymaga additional config): Bezpośredni dostęp do Zabbix Database dla lepszej wydajności (omija API)

3. **Direct DB Connection (zaawansowane):**
   - Wymaga dodatkowego datasource typu MySQL/PostgreSQL wskazującego na Zabbix Database
   - Zwiększa wydajność dla dużych środowisk (tysiące hostów)
   - Wymaga read-only user do bazy Zabbix

4. **Testowanie połączenia:**
   - "Save & Test" weryfikuje dostęp do Zabbix API i autoryzację

#### Przykładowe zapytanie w Grafanie (Zabbix datasource)

**Metryki z hosta:**
- Group: `Linux servers`
- Host: `webserver01`
- Application: `CPU`
- Item: `CPU utilization`

**Triggers (problemy):**
- Show problems: Yes
- Severity: Warning, High, Disaster
- Time range: Last 24 hours

**Funkcje agregacji:**
- `groupBy`: Grupowanie po hostach/applications
- `sumSeries`, `avgSeries`: Agregacja metryk z wielu hostów
- `aliasByNode`: Dynamiczne nazwy serii w legendzie

#### Provisioning jako kod (YAML)

```yaml
apiVersion: 1
datasources:
  - name: Zabbix
    type: alexanderzobnin-zabbix-datasource
    access: proxy
    url: http://zabbix-server/zabbix/api_jsonrpc.php
    jsonData:
      username: grafana
      trends: true
      cacheTTL: 1h
      dbConnectionEnable: false
    secureJsonData:
      password: ${ZABBIX_PASSWORD}
```

**Direct DB Connection (przykład):**

```yaml
  - name: Zabbix-DB
    type: mysql
    url: zabbix-mysql:3306
    database: zabbix
    user: zabbix_readonly
    jsonData:
      maxOpenConns: 10
    secureJsonData:
      password: ${ZABBIX_DB_PASSWORD}
```

### Do jakich zastosowań warto używać Zabbix z Grafaną

#### 1. **Monitoring infrastruktury on-premise i hybrydowej**
- Datacenter servers (Linux, Windows, AIX, Solaris)
- Network equipment (routers, switches, firewalls) via SNMP
- Hypervisors (VMware, Hyper-V, Proxmox)
- Storage (SAN, NAS) via SNMP/IPMI

**Korzyści:**
- Zabbix ma bogate wsparcie dla legacy hardware i proprietary protocols
- Auto-discovery sieci i urządzeń sieciowych
- Grafana pozwala na modern visualization istniejących danych Zabbix
- Możliwość łączenia Zabbix (infrastructure) z Prometheus (applications) w jednym dashboardzie

#### 2. **Enterprise monitoring z compliance requirements**
- Środowiska wymagające audytu i raportowania (banking, healthcare, government)
- SLA monitoring i capacity planning
- Multi-site monitoring (geograficznie rozproszone datacenters)

**Korzyści:**
- Zabbix oferuje granular RBAC (users, groups, permissions per host group)
- Audit log wszystkich zmian konfiguracyjnych
- Template-based approach ułatwia standaryzację i compliance
- Grafana dashboards dla executive reporting i SLA tracking

#### 3. **Migracja z legacy monitoringu**
- Stopniowe przejście z Nagios, Cacti, MRTG do nowoczesnej platformy
- Zabbix jako interim solution (zbieranie danych), Grafana jako docelowa warstwa wizualizacji
- Dual-stack: Zabbix dla legacy (SNMP, IPMI), Prometheus dla cloud-native apps

**Korzyści:**
- Zabbix obsługuje większość protokołów legacy (SNMP v1/v2c/v3, IPMI, Telnet)
- Import templates z Nagios/Cacti
- Grafana jako unified frontend eliminuje potrzebę nauki wielu UI

#### 4. **Alerting i incident management**
- Zaawansowane escalation scenarios (level 1 → level 2 → manager)
- Integration z ticketing systems (JIRA, ServiceNow, OTRS) via API
- Custom notification scripts (Slack, PagerDuty, MS Teams)

**Korzyści:**
- Zabbix trigger expressions są bardzo potężne (dependencies, hysteresis, maintenance windows)
- Problem flapping prevention (event correlation)
- Grafana może prezentować Zabbix problems jako annotations na wykresach

#### 5. **Monitoring aplikacji i middleware**
- Database monitoring (MySQL, PostgreSQL, Oracle, MSSQL) via templates
- Application servers (Apache, Nginx, Tomcat, JBoss) via JMX/HTTP
- Message queues (RabbitMQ, Kafka) via plugins

**Korzyści:**
- Zabbix templates community (share.zabbix.com) z tysiącami gotowych szablonów
- Low-level discovery dla automatic item creation (filesystems, network interfaces, database tables)
- Grafana umożliwia tworzenie unified app + infra dashboards

### Kluczowe korzyści ze stosowania Zabbix z Grafaną

| Aspekt | Korzyść |
|--------|---------|
| **Mature platform** | 25+ lat rozwoju, stabilność, wsparcie enterprise features (proxy, distributed monitoring) |
| **Protokoły legacy** | SNMP, IPMI, JMX – niezbędne w corporate environments |
| **All-in-one** | Monitoring + alerting + auto-discovery + templates w jednym rozwiązaniu |
| **Skalowalność** | Zabbix Proxy dla distributed/remote sites, Zabbix Server obsługuje 100k+ hostów (tuned setup) |
| **RBAC i multi-tenancy** | Granular permissions, user groups, host groups – idealne dla corporate |
| **Grafana visualization** | Nowoczesny UI, lepsze UX niż native Zabbix frontend, korelacja z innymi datasources |
| **Alerting** | Potężny silnik triggerów z dependencies, flapping prevention, maintenance windows |

### Typowe decyzje projektowe

1. **Zabbix Server architecture**: Single server vs distributed (Zabbix Proxy) – dla remote locations/DMZ
2. **Database backend**: MySQL/MariaDB (najpopularniejszy) vs PostgreSQL – impact na performance w dużych środowiskach
3. **Partitioning**: Database partitioning (by time) dla zarządzania history retention
4. **Housekeeper tuning**: Automatyczne czyszczenie starych danych – balance między retention a db size
5. **Active vs Passive items**: Active (agent-initiated, better for firewalls/NAT) vs Passive (server-initiated, simpler)
6. **Grafana integration approach**: API-based vs Direct DB Connection (performance trade-off)
7. **Template strategy**: Custom templates vs community templates – maintenance i customizacja

### Typowe pułapki produkcyjne

- **Database growth**: Brak partitioning/housekeeper tuning prowadzi do gigantycznych tabel (history, trends)
- **Over-monitoring**: Zbyt częste polling intervals (1s) dla tysięcy items – overload Zabbix Server i DB
- **Triggers complexity**: Zbyt skomplikowane expressions powodują wysokie CPU usage
- **Lack of proxies**: Single Zabbix Server dla geograficznie rozproszonych lokacji – network latency, bandwidth issues
- **Default credentials**: Niezmienianie domyślnych haseł (Admin/zabbix) – security risk
- **No monitoring of Zabbix itself**: Brak monitoringu Zabbix Server, DB, Proxies – blind spot
- **Template sprawl**: Nieudokumentowane custom templates, brak version control – chaos operacyjny
- **Direct DB access without read-only user**: Grafana z write permissions do Zabbix DB – ryzyko data corruption

### Wymagania środowiskowe (lab)

- Zabbix Server (Linux VM lub kontener, port 10051)
- Zabbix Web UI + Frontend (Apache/Nginx + PHP, port 80/443)
- Zabbix Database (MySQL/PostgreSQL)
- Zabbix Agent na monitorowanych hostach (port 10050)
- Grafana (port 3000)
- Minimum 2 GB RAM dla Zabbix Server (4–8 GB zalecane dla prod)
- Połączenie sieciowe między komponentami

### Rezultaty integracji

- Uczestnik potrafi skonfigurować Zabbix jako datasource w Grafanie
- Umie tworzyć zapytania wybierając hosty, items, applications, triggers
- Rozumie różnice między Zabbix (all-in-one, server-agent) a Prometheus (metrics-focused, scraping)
- Potrafi zaprojektować distributed Zabbix architecture z proxy dla remote sites
- Zna typowe zastosowania Zabbix w enterprise environments (SNMP, IPMI, legacy hardware)
- Rozumie trade-offy między native Zabbix visualization a Grafana integration
- Potrafi zidentyfikować typowe problemy performance (database size, polling frequency, trigger complexity)

