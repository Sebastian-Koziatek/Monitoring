### Automatyczny restart serwisu po wykryciu awarii - przykład z cockpit

---

## Krok 1: Instalacja Cockpit na Ubuntu 24.04

```bash
sudo apt update
sudo apt install cockpit
```

---

## Krok 2: Konfiguracja uprawnień sudo dla Zabbix

Aby Zabbix mógł restartować serwis Cockpit bez podawania hasła, dodaj odpowiedni wpis do pliku sudoers:

```bash
sudo visudo
```

Na końcu pliku dodaj linię:

```bash
zabbix ALL=(ALL) NOPASSWD: /bin/systemctl restart cockpit
```

---

## Krok 3: Utworzenie skryptu restartu w Zabbix WebUI

1. Przejdź do menu **Alerty → Skrypty**.
2. Kliknij **Utwórz skrypt**.
3. Uzupełnij pola:
   - ** Nazwa:** Restart cockpit service
   - ** Zakres:** Operacja akcji, Ręczna akcja na hoście, Ręczna akcja na zdarzeniu
   - ** Typ:** Skrypt
   - ** Wykonaj na:** Agent Zabbix
   - ** Polecenia:**

     ```bash
     sudo systemctl restart cockpit
     ```
   - ** Grupa hostów:** Wszystkie (lub wybrana)
4. Zatwierdź przyciskiem **Zaktualizuj**.

---

## Krok 4: Utworzenie pozycji do monitorowania serwisu

1. Przejdź do **Zbieranie danych → Hosty**.
2. Wybierz host, na którym działa Cockpit.
3. Przejdź do zakładki **Pozycje**.
4. Kliknij **Utwórz pozycję**.
5. Uzupełnij pola:
   - ** Nazwa pozycji:** Status Cockpit
   - ** Typ:** Zabbix agent
   - ** Klucz:**

     ```
     systemd.unit.info[cockpit.service,ActiveState]
     ```
   - ** Interwał:** np. 1m

---

## Krok 5: Wyzwalacz do automatycznego restartu serwisu

Aby automatycznie wykrywać awarię i uruchamiać restart, utwórz wyzwalacz:

- ** Wyrażenie:**

  ```
  last(/zabbix-client-2/systemd.unit.info[cockpit.service,ActiveState])<>"active"
  ```
- ** Opis:** Serwis Cockpit nie jest aktywny

Wyzwalacz ten uruchomi akcję (np. skrypt restartujący), gdy status serwisu Cockpit będzie inny niż "active".

---

## Przykład konfiguracji operacji w akcji autorejestracji

W sekcji **Operacje** akcja powinna zawierać następujące pozycje:

- ** Dodaj host**
- ** Dodaj do grup hostów:** Linux servers
- ** Połącz szablony:** Linux by Zabbix agent

Tak jak na poniższym przykładzie z interfejsu Zabbix:

```
Operacje
---------
Dodaj host
Dodaj do grup hostów: Linux servers
Połącz szablony: Linux by Zabbix agent
```

Każda operacja może być edytowana lub usunięta, a całość zatwierdzana przyciskiem **Zaktualizuj**.
