# Integracja Elasticsearch z GrafanƒÖ

## Wprowadzenie

Grafana oferuje zaawansowanƒÖ integracjƒô z Elasticsearch, umo≈ºliwiajƒÖc wizualizacjƒô log√≥w, metryk i zdarze≈Ñ. W tym rozdziale poznasz proces konfiguracji po≈ÇƒÖczenia oraz tworzenie paneli i dashboard√≥w wykorzystujƒÖcych dane z Elasticsearch.

---

## Dodanie ≈∫r√≥d≈Ça danych Elasticsearch

### Krok 1: Dodanie Data Source

```
Configuration (‚öôÔ∏è) ‚Üí Data Sources ‚Üí Add data source ‚Üí Elasticsearch
```

### Krok 2: Konfiguracja podstawowa

**Parametry po≈ÇƒÖczenia:**

| Parametr | Warto≈õƒá | Opis |
|----------|---------|------|
| **Name** | `Elasticsearch-Logs` | Nazwa ≈∫r√≥d≈Ça danych |
| **URL** | `http://localhost:9200` | Adres Elasticsearch |
| **Access** | `Server (default)` | Tryb dostƒôpu |
| **Index name** | `logs-*` | Wzorzec nazw indeks√≥w |
| **Time field** | `timestamp` | Pole z datƒÖ/czasem |
| **Version** | `8.0+` | Wersja Elasticsearch |

**Uwagi:**
- Je≈õli Elasticsearch wymaga uwierzytelnienia, w≈ÇƒÖcz sekcjƒô **Auth**
- Dla po≈ÇƒÖcze≈Ñ HTTPS dodaj certyfikat w sekcji **TLS/SSL Settings**

### Krok 3: Konfiguracja zaawansowana

```yaml
# Min time interval
Automatic

# Max concurrent Shard Requests
256 (domy≈õlnie)

# Log message field
message

# Log level field
level
```

### Krok 4: Test po≈ÇƒÖczenia

Kliknij **Save & Test**. Powinien pojawiƒá siƒô komunikat:
```
Data source is working
```

---

## Tworzenie wykres√≥w i wizualizacji

### 1. Wykres liczby log√≥w w czasie (Time Series)

**Scenario:** Wizualizacja liczby log√≥w per godzina.

```
1. Utw√≥rz nowy Panel
2. Wybierz Elasticsearch jako ≈∫r√≥d≈Ço danych
3. Konfiguracja Query:
```

**Zak≈Çadka Query:**
- **Metric**: Count
- **Group by**: Date Histogram
  - **Field**: `timestamp`
  - **Interval**: `1h`

**Lucene Query:**
```
level:ERROR OR level:CRITICAL
```

**Efekt:** Wykres liniowy pokazujƒÖcy liczbƒô b≈Çƒôd√≥w w czasie.

### 2. Wykres z filtrowaniem po serwisie

**Query z agreacjƒÖ:**

```json
{
  "size": 0,
  "query": {
    "bool": {
      "filter": [
        {
          "range": {
            "timestamp": {
              "gte": "$__timeFrom",
              "lte": "$__timeTo",
              "format": "epoch_millis"
            }
          }
        }
      ]
    }
  },
  "aggs": {
    "time_buckets": {
      "date_histogram": {
        "field": "timestamp",
        "fixed_interval": "$__interval",
        "time_zone": "Europe/Warsaw",
        "min_doc_count": 0
      },
      "aggs": {
        "services": {
          "terms": {
            "field": "service.keyword",
            "size": 10
          }
        }
      }
    }
  }
}
```

**Wyja≈õnienie zmiennych Grafany:**
- `$__timeFrom`: PoczƒÖtek zakresu czasowego z Time Picker
- `$__timeTo`: Koniec zakresu czasowego
- `$__interval`: Automatyczny interwa≈Ç zale≈ºny od zakresu

### 3. Stat Panel - liczba b≈Çƒôd√≥w

**Konfiguracja:**
- **Visualization**: Stat
- **Metric**: Count
- **Query**: `level:ERROR`
- **Time range**: Last 1 hour

**Transformacje:**
- Calculation: Last (ostatnia warto≈õƒá)
- Display: Warto≈õƒá + Sparkline

### 4. Gauge - ≈õredni czas odpowiedzi

**Query:**
```json
{
  "size": 0,
  "aggs": {
    "avg_response": {
      "avg": {
        "field": "response_time_ms"
      }
    }
  }
}
```

**Konfiguracja Gauge:**
- Min: 0
- Max: 1000
- Thresholds:
  - Green: 0-200
  - Yellow: 200-500
  - Red: 500+

### 5. Bar Gauge - top serwisy z b≈Çƒôdami

**Query:**
```json
{
  "size": 0,
  "query": {
    "term": {
      "level": "ERROR"
    }
  },
  "aggs": {
    "services": {
      "terms": {
        "field": "service.keyword",
        "size": 10,
        "order": { "_count": "desc" }
      }
    }
  }
}
```

**Visualization**: Bar Gauge (horizontal)

### 6. Table - szczeg√≥≈Çowe logi

**Konfiguracja:**
- **Visualization**: Table
- **Metric**: Raw Documents
- **Size**: 100
- **Sort**: `timestamp` DESC

**Columns:**
```
timestamp | level | service | message | user | ip
```

**Query:**
```
level:ERROR AND service:payment*
```

---

## U≈ºycie Lucene Query Syntax

Grafana wspiera Lucene Query Syntax do filtrowania danych w Elasticsearch.

### Podstawowa sk≈Çadnia

```bash
# Dok≈Çadne dopasowanie
level:ERROR

# Frazowanie
message:"connection timeout"

# Wielokrotne warto≈õci (OR)
level:(ERROR OR CRITICAL)

# Wielokrotne pola (AND)
level:ERROR AND service:auth-service

# Negacja
NOT level:INFO

# Wildcard
service:auth*

# Zakres
response_time_ms:[100 TO 500]

# Exists
_exists_:error_code

# Kombinacje
level:ERROR AND service:payment* NOT environment:test
```

### Przyk≈Çady praktyczne

```bash
# B≈Çƒôdy z payment-service z ostatnich 15 minut
level:ERROR AND service:payment-service

# Wolne requesty (>3s)
response_time_ms:>3000

# Nieudane logowania
message:"login failed" OR message:"authentication error"

# Wszystkie b≈Çƒôdy opr√≥cz testowych
level:ERROR NOT environment:test

# Specificzne kody b≈Çƒôd√≥w
error_code:(500 OR 502 OR 503)
```

---

## Variables (zmienne)

### 1. Query Variable - lista serwis√≥w

**Konfiguracja:**
- Name: `service`
- Type: Query
- Data source: Elasticsearch
- Query:
  ```json
  {"find": "terms", "field": "service.keyword"}
  ```

**U≈ºycie w panelu:**
```
service:$service
```

### 2. Multi-value Variable

**Konfiguracja:**
- Multi-value: ‚úÖ
- Include All option: ‚úÖ

**Query w panelu z multi-select:**
```
service:($service)
```

### 3. Time Range Variable

**Konfiguracja:**
- Name: `timerange`
- Type: Interval
- Values: `1h,6h,12h,24h,7d`

**U≈ºycie:**
```json
{
  "query": {
    "range": {
      "timestamp": {
        "gte": "now-$timerange"
      }
    }
  }
}
```

---

## Logs Panel

Grafana oferuje dedykowany panel do wy≈õwietlania log√≥w.

### Konfiguracja Logs Panel

**Zapytanie:**
```
level:ERROR OR level:WARNING
```

**Settings:**
- **Time**: `timestamp`
- **Unique labels**: `service`, `level`, `host`
- **Show time**: ‚úÖ
- **Wrap lines**: ‚úÖ

**Efekt:** Interfejs podobny do `tail -f` z mo≈ºliwo≈õciƒÖ filtrowania i wyszukiwania.

### Derived Fields

Automatyczne wydobywanie link√≥w z log√≥w.

**Przyk≈Çad - link do requestu:**

```
Name: Request ID
Regex: request_id=([a-f0-9]{32})
URL: http://app.example.com/requests/$1
```

---

## Przyk≈Çadowy Dashboard

### Dashboard: Application Monitoring

**Row 1: Overview**
- **Stat**: Total Logs (last 1h)
- **Stat**: Error Count (last 1h)
- **Stat**: Critical Count (last 1h)
- **Gauge**: Avg Response Time

**Row 2: Trends**
- **Time Series**: Logs over time (grouped by level)
- **Time Series**: Response time (p50, p90, p95)

**Row 3: Breakdown**
- **Bar Gauge**: Top Services with Errors
- **Pie Chart**: Log Levels Distribution

**Row 4: Details**
- **Table**: Recent Errors
- **Logs**: Error Stream

**Variables:**
- `$service`: Multi-select (All services)
- `$level`: Multi-select (ERROR, WARNING, INFO)
- `$environment`: Single select (production, staging)

---

## Alerting

### Utworzenie alertu dla b≈Çƒôd√≥w

**Scenariusz:** Alert gdy liczba b≈Çƒôd√≥w > 100 w ciƒÖgu 5 minut.

**Konfiguracja:**

1. **Query:**
   ```
   level:ERROR
   ```
   - Metric: Count
   - Group by: Date Histogram (1m interval)

2. **Alert Rule:**
   ```
   WHEN last() OF query(A, 5m, now) IS ABOVE 100
   ```

3. **Notifications:**
   - Send to: Slack, Email, PagerDuty
   - Message:
     ```
     üö® High error rate detected!
     Errors in last 5 minutes: {{ $values.A }}
     ```

### Alert dla wolnych request√≥w

**Query:**
```json
{
  "query": {
    "range": {
      "response_time_ms": {
        "gte": 5000
      }
    }
  }
}
```

**Condition:**
```
WHEN last() OF query(A, 5m, now) IS ABOVE 50
```

---

## Optymalizacja wydajno≈õci

### 1. Ograniczenie zakresu czasowego

Zawsze u≈ºywaj filtra czasowego w query:
```json
{
  "query": {
    "range": {
      "timestamp": {
        "gte": "$__timeFrom",
        "lte": "$__timeTo",
        "format": "epoch_millis"
      }
    }
  }
}
```

### 2. U≈ºywaj `size: 0` dla agregacji

```json
{
  "size": 0,
  "aggs": { ... }
}
```

### 3. Indeksy z codziennƒÖ rotacjƒÖ

Lepiej:
```
logs-nginx-2024.02.14
logs-nginx-2024.02.15
```

Ni≈º:
```
logs-nginx-all
```

### 4. Reducers w Grafanie

U≈ºywaj transformacji w Grafanie zamiast skomplikowanych agregacji w ES.

---

## Najlepsze praktyki

### 1. Conventions nazewnictwa

```
[type]-[application]-[date]
logs-nginx-2024.02.14
metrics-cpu-2024.02
```

### 2. Struktura dashboard√≥w

- **Overview Dashboard**: Og√≥lny widok (wszystkie aplikacje)
- **Service-specific**: Dedykowane dashboardy per serwis
- **Troubleshooting**: Dashboard do szybkiej diagnostyki

### 3. Variables

U≈ºywaj zmiennych do:
- Filtrowania serwis√≥w/≈õrodowisk
- Dynamicznych zakres√≥w czasowych
- Multi-tenant dashboards

### 4. Annotations

Dodawaj adnotacje dla deployment√≥w:
```json
{
  "query": {
    "term": {
      "event_type": "deployment"
    }
  }
}
```

---

## Przyk≈Çadowe zapytania do paneli

### Panel 1: Error Rate per Service

```json
{
  "size": 0,
  "query": {
    "bool": {
      "filter": [
        { "term": { "level": "ERROR" }},
        { "range": { "timestamp": { "gte": "$__timeFrom", "lte": "$__timeTo" }}}
      ]
    }
  },
  "aggs": {
    "services": {
      "terms": { "field": "service.keyword", "size": 20 },
      "aggs": {
        "errors_over_time": {
          "date_histogram": {
            "field": "timestamp",
            "fixed_interval": "$__interval"
          }
        }
      }
    }
  }
}
```

### Panel 2: Response Time Percentiles

```json
{
  "size": 0,
  "query": {
    "range": { "timestamp": { "gte": "$__timeFrom", "lte": "$__timeTo" }}
  },
  "aggs": {
    "time_buckets": {
      "date_histogram": {
        "field": "timestamp",
        "fixed_interval": "$__interval"
      },
      "aggs": {
        "percentiles": {
          "percentiles": {
            "field": "response_time_ms",
            "percents": [50, 90, 95, 99]
          }
        }
      }
    }
  }
}
```

---

## Podsumowanie

Integracja Elasticsearch z GrafanƒÖ oferuje:
- **Zaawansowane wizualizacje**: Time series, stat, gauge, logs panel
- **Lucene Query Syntax**: Elastyczne filtrowanie danych
- **Variables**: Dynamiczne dashboardy
- **Alerting**: Powiadomienia o problemach
- **Optymalizacja**: Wydajne zapytania dla du≈ºych zbior√≥w danych

Po≈ÇƒÖczenie Elasticsearch (gromadzenie i indeksowanie) z GrafanƒÖ (wizualizacja) tworzy potƒô≈ºne narzƒôdzie do monitoringu aplikacji i anality–∫–∏ log√≥w.
